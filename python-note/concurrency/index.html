<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Concurrency - Fatma Kahveci</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="Concurrency">
		<meta property="og:title" content="Concurrency" />
<meta property="og:description" content="Concurrency" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://fatmakahveci.com/python-note/concurrency/" /><meta property="article:section" content="python-note" />



		<meta itemprop="name" content="Concurrency">
<meta itemprop="description" content="Concurrency">

<meta itemprop="wordCount" content="10649">
<meta itemprop="keywords" content="Python,coding,algorithms,data structures," />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Life+Savers:wght@700&display=swap">

	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="Fatma Kahveci" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">Fatma Kahveci</div>
					
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/coding-note/">
				
				<span class="menu__text">coding</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/python-note/">
				
				<span class="menu__text">python</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/backend-note/">
				
				<span class="menu__text">backend</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/frontend-note/">
				
				<span class="menu__text">frontend</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/go-note/">
				
				<span class="menu__text">go</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/bash-note/">
				
				<span class="menu__text">bash</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/aws-note/">
				
				<span class="menu__text">aws</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/travel-note/">
				
				<span class="menu__text">Travel</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/reading-note/">
				
				<span class="menu__text">Reading</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Concurrency</h1>
			<div class="post__meta meta"><div class="meta__item-author meta__item">
	<svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2 0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class="meta__text">Fatma Kahveci</span>
</div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/coding/" rel="category">Coding</a>
	</span>
</div></div>
		</header>
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
  <ul>
    <li><a href="#concurrency-in-python">Concurrency in Python</a>
      <ul>
        <li><a href="#asyncios-_hello-world_">asyncio&rsquo;s <em>Hello World!</em></a></li>
        <li><a href="#awaitable">Awaitable</a></li>
        <li><a href="#coroutine">Coroutine</a></li>
        <li><a href="#event-loop">Event Loop</a></li>
        <li><a href="#future">Future</a></li>
        <li><a href="#task">Task</a></li>
        <li><a href="#running-in-threads">Running in Threads</a></li>
      </ul>
    </li>
    <li><a href="#aiohttp">aiohttp</a>
      <ul>
        <li><a href="#asycnhronous-http-clientserver-for-asyncio-and-python-aiohttp">Asycnhronous HTTP client/server for asyncio and python (<code>aiohttp</code>)</a></li>
      </ul>
    </li>
    <li><a href="#async-delay-app">async delay app</a></li>
    <li><a href="#asyncgenerator">AsyncGenerator</a></li>
    <li><a href="#async-input-reader">async input reader</a></li>
    <li><a href="#awaitables">Awaitables</a></li>
    <li><a href="#web-applications">Web Applications</a>
      <ul>
        <li><a href="#creating-web-applications-with-aiohttpaiohttpmd">Creating web applications with <a href="../aiohttp.md"><code>aiohttp</code></a></a></li>
        <li><a href="#asgi">ASGI</a></li>
        <li><a href="#creating-asgi-web-applications-with-starlette">Creating ASGI web applications with Starlette</a></li>
        <li><a href="#using-djangos-asynchronous-views">Using Django&rsquo;s asynchronous views</a></li>
      </ul>
    </li>
    <li><a href="#event-loop-1">Event loop</a>
      <ul>
        <li><a href="#use-asyncios-non-blocking-socket-coroutines-to-allow-multi-clients-to-connect-properly">Use <code>asyncio</code>&rsquo;s non-blocking socket coroutines to allow multi-clients to connect properly</a></li>
        <li><a href="#event-loop-coroutines-for-sockets">Event loop coroutines for sockets</a></li>
      </ul>
    </li>
    <li><a href="#chat-client">chat client</a></li>
    <li><a href="#chat-server">chat server</a></li>
    <li><a href="#cli-sql">cli sql</a></li>
    <li><a href="#designing-an-asyncio-echo-server">Designing an <code>asyncio</code> echo server</a></li>
    <li><a href="#requests"><code>requests</code></a>
      <ul>
        <li><a href="#status-codes">Status codes</a></li>
        <li><a href="#session-objects">Session Objects</a></li>
      </ul>
    </li>
    <li><a href="#build-socket-based-network-applications-with-asyncio-that-can-handle-multi-client-simultaneously-with-one-thread">Build socket-based network applications with <code>asyncio</code> that can handle multi-client simultaneously with one thread</a>
      <ul>
        <li><a href="#1-starting-a-server-and-listening-for-a-connection">1. Starting a server and listening for a connection</a></li>
        <li><a href="#2-reading-and-writing-data-to-and-from-a-socket">2. Reading and writing data to and from a socket</a></li>
        <li><a href="#3-build-a-multi-client-echo-server-using-non-blocking-sockets-and-os-event-notification-system">3. Build a multi-client echo server using non-blocking sockets and OS&rsquo; event notification system</a></li>
        <li><a href="#4-use-the-selectors-module-to-build-a-socket-event-loop">4. Use the <code>selectors</code> module to build a socket event loop</a></li>
        <li><a href="#5-add-custom-shutdown-logic">5. Add custom shutdown logic</a></li>
      </ul>
    </li>
    <li><a href="#concurrency-methods">Concurrency methods</a>
      <ul>
        <li><a href="#multiple-processing">Multiple processing</a></li>
        <li><a href="#single-processing">Single processing</a></li>
      </ul>
    </li>
    <li><a href="#concurrent-futures">concurrent futures</a>
      <ul>
        <li><a href="#concurrentfutures-module"><code>concurrent.futures</code> module</a></li>
        <li><a href="#executor">executor</a></li>
      </ul>
    </li>
    <li><a href="#handling-cpu-bound-work">Handling CPU-bound work</a>
      <ul>
        <li><a href="#using-process-pools">Using process pools</a></li>
        <li><a href="#using-async-and-await-to-manage-cpu-bound-work">Using <code>async</code> and <code>await</code> to manage CPU-bound work</a></li>
        <li><a href="#solving-a-problem-with-mapreduce-using-asyncio">Solving a problem with MapReduce using <code>asyncio</code></a></li>
        <li><a href="#handling-shared-data-between-multiple-processes-with-locks">Handling shared data between multiple processes with locks</a></li>
      </ul>
    </li>
    <li><a href="#handling-blocking-work-with-threads">Handling blocking work with threads</a>
      <ul>
        <li><a href="#1-threading-module">1. <code>threading</code> module</a></li>
        <li><a href="#2-using-threads-with-asyncio">2. Using threads with <code>asyncio</code></a></li>
        <li><a href="#3-locks-shared-data-and-deadlocks">3. Locks, shared data, and deadlocks</a></li>
        <li><a href="#4-event-loops-in-separate-threads">4. Event loops in separate threads</a></li>
        <li><a href="#5-using-threads-for-cpu-bound-work">5. Using threads for CPU-bound work</a></li>
      </ul>
    </li>
    <li><a href="#multithread-hashing">Multithread hashing</a></li>
    <li><a href="#multithread-numpy">Multithread numpy</a></li>
    <li><a href="#multithread-echo-server">Multithread echo server</a></li>
    <li><a href="#non-blocking-database-drivers">Non-blocking database drivers</a>
      <ul>
        <li><a href="#running-asyncio-friendly-database-queries-with-asyncpg">Running asyncio-friendly database queries with <code>asyncpg</code></a></li>
        <li><a href="#executing-queries-concurrently-with-connection-pools">Executing queries concurrently with connection pools</a></li>
        <li><a href="#managing-asynchronous-database-transactions-and-handling-an-error-in-a-transaction">Managing asynchronous database transactions and handling an error in a transaction</a></li>
        <li><a href="#using-asynchronous-generators-to-stream-query-results">Using asynchronous generators to stream query results</a></li>
      </ul>
    </li>
    <li><a href="#protocol">Protocol</a></li>
    <li><a href="#server">server</a></li>
    <li><a href="#stream-reader">Stream reader</a></li>
    <li><a href="#streams">Streams</a>
      <ul>
        <li><a href="#stream-readers-and-stream-writers">Stream readers and stream writers</a></li>
        <li><a href="#using-streams-for-network-connections">Using streams for network connections</a></li>
        <li><a href="#processing-command-line-input-asynchronously">Processing command-line input asynchronously</a></li>
        <li><a href="#creating-servers">Creating servers</a></li>
      </ul>
    </li>
    <li><a href="#subroutine">Subroutine</a></li>
    <li><a href="#mapreduce-process-pools">Mapreduce process pools</a></li>
    <li><a href="#lock">Lock</a>
      <ul>
        <li><a href="#process-lock">Process lock</a></li>
        <li><a href="#thread-lock">Thread lock</a></li>
      </ul>
    </li>
    <li><a href="#thread">Thread</a>
      <ul>
        <li><a href="#to-thread">to thread</a></li>
      </ul>
    </li>
    <li><a href="#synchronization">Synchronization</a>
      <ul>
        <li><a href="#asyncio-lock">asyncio lock</a></li>
        <li><a href="#single-threaded-concurrency-issues">Single-threaded concurrency issues</a></li>
        <li><a href="#uses-of-synchronization-primitives">Uses of synchronization primitives</a></li>
        <li><a href="#solving-race-conditions-_with_-locks-and-other-concurrency-primitives">Solving race conditions <em>with</em> locks and other concurrency primitives</a></li>
        <li><a href="#limiting-concurrency-and-controlling-access-to-a-shared-source-_with_-semaphores">Limiting concurrency and controlling access to a shared source <em>with</em> semaphores</a></li>
        <li><a href="#notifying-tasks-when-something-occurs-and-acquiring-the-shared-sources-when-it-happens-_with_-events-and-conditions">Notifying tasks when something occurs and acquiring the shared sources when it happens <em>with</em> events and conditions</a></li>
        <li><a href="#queues">Queues</a></li>
      </ul>
    </li>
    <li><a href="#utils">utils</a>
      <ul>
        <li><a href="#async-timed">async timed</a></li>
        <li><a href="#create-stdin-reader">create stdin reader</a></li>
        <li><a href="#cursor">cursor</a></li>
        <li><a href="#delay">delay</a></li>
        <li><a href="#fetch-status">fetch status</a></li>
        <li><a href="#message-store">message store</a></li>
      </ul>
    </li>
  </ul>
</nav>
	</div>
</div>
<div class="content post__content clearfix">
			<h2 id="concurrency-in-python">Concurrency in Python</h2>
<h3 id="asyncios-_hello-world_">asyncio&rsquo;s <em>Hello World!</em></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#39;Hello World!&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h3 id="awaitable">Awaitable</h3>
<ul>
<li>An object that can be used in an <code>await</code> expression.</li>
</ul>
<h3 id="coroutine">Coroutine</h3>
<ul>
<li>A coroutine can be thought of as executing a lightweight thread.</li>
<li>It is a special Python function that behaves as a generator and yields control back to the event loop when it blocks.</li>
<li>It is a specialized version of a Python <code>generator</code> function.</li>
<li>It is like a regular function with the superpower that can be paused when we have a potentially long-running task and then resumed when that task is finished.
<ul>
<li>When a long-running operation is complete, we can &ldquo;wake up&rdquo; our paused coroutine and finish executing any other code in that coroutine.</li>
<li>While a paused coroutine is waiting for the operation it paused for to finish, we can run other code.</li>
</ul>
</li>
</ul>
<p><img src="/img/subroutine_vs_coroutine.png" alt="subroutine_vs_coroutine"></p>
<h4 id="1-creating-coroutines-with-the-async-keyword">1. Creating coroutines with the <code>async</code> keyword</h4>
<ul>
<li>Coroutines aren&rsquo;t executed when we call them directly. Instead, we create a coroutine object that can be run later.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_one</span>(number: int) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> number <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">coroutine_add_one</span>(number: int) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> number <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>function_result <span style="color:#f92672">=</span> add_one(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>coroutine_result <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>run(coroutine_add_one(<span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Function result is </span><span style="color:#e6db74">{</span>function_result<span style="color:#e6db74">}</span><span style="color:#e6db74"> and the type is </span><span style="color:#e6db74">{</span>type(function_result)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Coroutine result is </span><span style="color:#e6db74">{</span>coroutine_result<span style="color:#e6db74">}</span><span style="color:#e6db74"> and the type is </span><span style="color:#e6db74">{</span>type(coroutine_result)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><h5 id="11-asynciorun-steps">1.1. <code>asyncio.run</code> steps</h5>
<ul>
<li>It creates a brand-new event.</li>
<li>It takes the coroutine we pass into it and runs it until it completes, returning the result.</li>
<li>It cleans anything left running after the main coroutine finishes.</li>
<li>Once everything has finished, it shuts down and closes the event loop.</li>
</ul>
<h4 id="2-pausing-execution-with-the-await-keyword">2. Pausing execution with the <code>await</code> keyword</h4>
<ul>
<li><code>await</code> is usually followed by a call to a coroutine.</li>
<li>When we hit an <code>await</code> expression, we pause our parent coroutine and run the coroutine in the await expression. Once it is finished, we resume the parent coroutine and assign the return value.</li>
<li><code>awaitable</code> is the object that can be used in <code>await</code> expressions.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_one</span>(number: int) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> number <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  one_plus_one <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> add_one(<span style="color:#ae81ff">1</span>) <span style="color:#75715e"># pause and wait for the result of add_one(1)</span>
</span></span><span style="display:flex;"><span>  two_plus_one <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> add_one(<span style="color:#ae81ff">2</span>) <span style="color:#75715e"># pause and wait for the result of add_one(2)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  print(one_plus_one)
</span></span><span style="display:flex;"><span>  print(two_plus_one)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h4 id="long-running-coroutines-with-sleep">Long-running coroutines with sleep</h4>
<h5 id="asynciosleep"><code>asyncio.sleep</code></h5>
<ul>
<li>It makes a coroutine sleep for a given number of seconds.</li>
<li>It is a coroutine so we must use it with the <code>await</code> keyword.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util <span style="color:#f92672">import</span> delay <span style="color:#75715e"># our module</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_one</span>(number: int) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> number <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello_world_message</span>() <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> delay(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Hello world!&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  message <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> hello_world_message()
</span></span><span style="display:flex;"><span>  one_plus_one <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> add_one(<span style="color:#ae81ff">1</span>) 
</span></span><span style="display:flex;"><span>  print(one_plus_one)
</span></span><span style="display:flex;"><span>  print(message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h3 id="event-loop">Event Loop</h3>
<ul>
<li>The event loop is the core of every asyncio application.</li>
<li>Event loops run asynchronous tasks and callbacks, perform network IO operations, and run subprocesses.</li>
</ul>
<h3 id="future">Future</h3>
<ul>
<li>
<p><code>Future</code> is an awaitable object. Coroutines can await on Future objects until they either have a result or an exception set or until they are cancelled.</p>
</li>
<li>
<p>A <code>future</code> is an awaitable object that contains a single value that you expect to get at some point or time in the future but may not have yet.</p>
</li>
<li>
<p>Futures can also be used in <code>await</code> expressions so we&rsquo;re saying &ldquo;pause&rdquo; until the future has a value set that I can work with, and once I have a value, wake up and let me process it.</p>
</li>
<li>
<p>We call <code>set_exception</code> to set an exception on the <code>future</code>.</p>
</li>
<li>
<p>In the world of <code>asyncio</code>, you should rarely need to deal with <code>future</code>s.</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncio <span style="color:#f92672">import</span> Future
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_request</span>() <span style="color:#f92672">-&gt;</span> Future:
</span></span><span style="display:flex;"><span>  future <span style="color:#f92672">=</span> Future()
</span></span><span style="display:flex;"><span>  asyncio<span style="color:#f92672">.</span>create_task(set_future_value(future)) <span style="color:#75715e"># create a task asynchronously set the value of the future</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> future
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_future_value</span>(future) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>) <span style="color:#75715e"># wait 1 sec before setting the value of future</span>
</span></span><span style="display:flex;"><span>  future<span style="color:#f92672">.</span>set_result(<span style="color:#ae81ff">42</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  future <span style="color:#f92672">=</span> make_request()
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Is the future done? </span><span style="color:#e6db74">{</span>future<span style="color:#f92672">.</span>done()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>  value <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> future <span style="color:#75715e"># pause main until the future is set</span>
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Is the future done? </span><span style="color:#e6db74">{</span>future<span style="color:#f92672">.</span>done()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>  print(value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><ul>
<li><code>async for</code> and <code>async with</code></li>
</ul>
<h3 id="task">Task</h3>
<ul>
<li>A <code>Future-like</code> object that runs a Python <code>coroutine</code>.</li>
<li><code>task</code> directly inherits from <code>future</code>.</li>
<li>It is a combination of both a <code>coroutine</code> and <code>future</code>.</li>
<li>When we create a <code>task</code>, we create an empty <code>future</code> and run the <code>coroutine</code>. Then, when the coroutine has completed with either an exception or a result, we set the result or exception of the future.</li>
<li>Each task maintains a single stack, and its execution pointer as well.</li>
<li>A task object can be used to monitor the status of the underlying coroutine.</li>
</ul>
<h4 id="running-concurrently-with-tasks">Running concurrently with tasks</h4>
<ul>
<li>A task makes the coroutine run concurrently.</li>
<li>It is a wrapper around the coroutine that schedules a coroutine to run on the event loop as soon as possible so we can execute multiple tasks at roughly the same time.</li>
</ul>
<h5 id="asynciocreate_task"><code>asyncio.create_task</code></h5>
<ul>
<li>It schedules the execution of a <code>Coroutines</code>, gives it to run, and returns a Task object instantly.</li>
<li>It gives a coroutine to run and returns a task object instantly.</li>
<li>It takes a coroutine object as a parameter and returns a <code>Task</code> object.</li>
<li>Once we have a <code>Task</code> object, we can put it in an <code>await</code> expression that will extract the return value once it is complete.</li>
<li>We should usually use an <code>await</code> keyword on our tasks at some point in our application.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util <span style="color:#f92672">import</span> delay
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  sleep_for_three <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(delay(<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>  print(type(sleep_for_three))
</span></span><span style="display:flex;"><span>  result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> sleep_for_three
</span></span><span style="display:flex;"><span>  print(result)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h4 id="running-multiple-tasks-concurrently">Running multiple tasks concurrently</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util.delay <span style="color:#f92672">import</span> delay
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  sleep_for_three <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(delay(<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>  sleep_again <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(delay(<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>  sleep_once_more <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(delay(<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> sleep_for_three
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> sleep_again
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> sleep_once_more
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util.delay <span style="color:#f92672">import</span> delay
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello_every_second</span>():
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">2</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;I am running other code while I am running&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  first_delay <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(delay(<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>  second_delay <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(delay(<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> hello_every_second()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> first_delay
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> second_delay
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h4 id="canceling-tasks">Canceling tasks</h4>
<ul>
<li>Cancelling a task will cause that task to raise a <code>CancelledError</code> when we <code>await</code> it, which we can then handle as needed.</li>
<li><code>CancelledError</code> can only be thrown from an <code>await</code> statement. This means that if we call to cancel on a task when it is executing plain Python code, that code will run until completion until we hit the next <code>await</code> statement (if one exists) and a <code>CancelledError</code> can be raised. Calling cancel won’t magically stop the task in its tracks; it will only stop the task if you’re currently at an <code>await</code> point or its next <code>await</code> point.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util.delay <span style="color:#f92672">import</span> delay
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncio <span style="color:#f92672">import</span> CancelledError
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  long_task <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(delay(<span style="color:#ae81ff">10</span>))
</span></span><span style="display:flex;"><span>  seconds_elapsed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> long_task<span style="color:#f92672">.</span>done():
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;Task is not finished, checking again in a second.&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    seconds_elapsed <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> seconds_elapsed <span style="color:#f92672">==</span> <span style="color:#ae81ff">5</span>:
</span></span><span style="display:flex;"><span>      long_task<span style="color:#f92672">.</span>cancel()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> long_task
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">except</span> CancelledError:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;Our task was cancelled.&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h4 id="setting-a-timeout-and-cancelling-with-wait_for">Setting a timeout and cancelling with <code>wait_for</code></h4>
<ul>
<li>It takes in a coroutine or task object, and a timeout is specified in seconds. Then, it returns a coroutine that we can <code>await</code>.</li>
<li>If the task exceeds the specified timeout, a <code>TimeoutException</code> will be raised. Once we have reached the timeout threshold, the task will automatically be cancelled.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util.delay <span style="color:#f92672">import</span> delay
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  delay_task <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(delay(<span style="color:#ae81ff">2</span>))
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>wait_for(delay_task, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    print(result)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">except</span> asyncio<span style="color:#f92672">.</span>exceptions<span style="color:#f92672">.</span>TimeoutError:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;Got a timeout!&#39;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Was the task cancelled? </span><span style="color:#e6db74">{</span>delay_task<span style="color:#f92672">.</span>cancelled()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h4 id="shielding-a-task-from-cancellation-shield">Shielding a task from cancellation <code>shield</code></h4>
<ul>
<li>It prevents cancellation of the coroutine we pass in, giving it a &lsquo;shield&rsquo;, which cancellation requests then ignore.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util.delay <span style="color:#f92672">import</span> delay
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  delay_task <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(delay(<span style="color:#ae81ff">10</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>wait_for(asyncio<span style="color:#f92672">.</span>shield(delay_task), <span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>    print(result)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">except</span> asyncio<span style="color:#f92672">.</span>exceptions<span style="color:#f92672">.</span>TimeoutError:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;Task took longer than five seconds, it will finish soon&#39;</span>)
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> delay_task
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;finished in </span><span style="color:#e6db74">{</span>result<span style="color:#e6db74">}</span><span style="color:#e6db74"> second(s)&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h3 id="running-in-threads">Running in Threads</h3>
<ul>
<li><code>asyncio.to_thread(&lt;function&gt;, /, *args, **kwargs)</code></li>
</ul>
<p><a href="https://docs.python.org/" target="_blank" >Ref</a>
</p>
<hr>
<h2 id="aiohttp">aiohttp</h2>
<h3 id="asycnhronous-http-clientserver-for-asyncio-and-python-aiohttp">Asycnhronous HTTP client/server for asyncio and python (<code>aiohttp</code>)</h3>
<ul>
<li><code>pip install aiohttp</code></li>
<li>It makes asyncio-friendly web requests.</li>
<li>It uses non-blocking sockets to make web requests and returns coroutines for them, which then can <code>await</code> for a result.</li>
<li>It has not only support as an HTTP client but also has the functionality to create asyncio-ready web application servers as well.</li>
<li>It provides web server functionality in the web module.</li>
</ul>
<h4 id="asynchronous-context-managerscontext_managermd">Asynchronous <a href="../context_manager.md" >context managers</a>
</h4>
<ul>
<li><code>with</code> works for the synchronous. <code>async with</code> works for the asynchronous.</li>
<li>It acquires and closes HTTP sessions cleanly with two special coroutine methods:
<ol>
<li><code>__aenter__</code> acquires a resource.</li>
<li><code>__aexit__</code> closes the resource.</li>
</ol>
</li>
<li>Normally, you won&rsquo;t need to write your own async database connections and transactions.</li>
</ul>
<h4 id="session">Session</h4>
<ul>
<li><code>aiohttp</code> can create a session by using <code>async with</code> and <code>aiohttp.ClientSession</code>.</li>
<li>Within a session, you can keep many connections open, which can then be recycled (connection pooling).</li>
<li>A session object has methods to make any number of web requests, such as <code>GET</code>, <code>PUT</code>, and <code>POST</code>.</li>
<li>A <code>ClientSession</code> will create a default maximum of 100 connections by default. To change this limit, we can create an instance of an <code>aiohttp TCPConnector</code> specifying the maximum number of connections and passing that to the <code>ClientSession</code>.</li>
</ul>
<h4 id="setting-and-handling-timeouts-for-groups-of-requests-and-cancelling-requests">Setting and handling timeouts for groups of requests and cancelling requests</h4>
<ul>
<li><code>ClientTimeout</code> data structure can specify timeouts for an entire request, establishing a connection, or reading data.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> aiohttp <span style="color:#f92672">import</span> ClientSession, ClientTimeout
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util <span style="color:#f92672">import</span> fetch_status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  session_timeout <span style="color:#f92672">=</span> ClientTimeout(total<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, connect<span style="color:#f92672">=</span><span style="color:#ae81ff">.1</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> ClientSession(timeout<span style="color:#f92672">=</span>session_timeout) <span style="color:#66d9ef">as</span> session:  <span style="color:#75715e"># creates a session</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> fetch_status(session, <span style="color:#e6db74">&#39;https://example.com&#39;</span>)  <span style="color:#75715e"># returns a status code for the given URL</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h4 id="running-tasks-concurrently">Running tasks concurrently</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util <span style="color:#f92672">import</span> async_timed, delay
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@async_timed</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  delay_times <span style="color:#f92672">=</span> [ <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span> ]
</span></span><span style="display:flex;"><span>  tasks <span style="color:#f92672">=</span> [ <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>create_task(delay(seconds)) <span style="color:#66d9ef">for</span> seconds <span style="color:#f92672">in</span> delay_times ]
</span></span><span style="display:flex;"><span>  [ <span style="color:#66d9ef">await</span> task <span style="color:#66d9ef">for</span> task <span style="color:#f92672">in</span> tasks ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><ul>
<li>
<p>It creates several tasks all at once in the tasks list. Once we have created all the tasks, we await their completion in a separate list comprehension. This works because <code>create_task</code> returns instantly, and we don&rsquo;t do any awaiting until all the tasks have been created. This ensures that it only requires at most the maximum pause in <code>delay_times</code>, giving a runtime of about 3 seconds.</p>
</li>
<li>
<p><strong>Drawbacks:</strong></p>
<ul>
<li>If one of our coroutines finishes long before the others, we&rsquo;ll be trapped in the second list comprehension waiting for all other coroutines to finish.</li>
<li>If one of our coroutines has an exception, it will be thrown when we await the failed task. This means that we won&rsquo;t be able to process any tasks that were completed successfully because that one exception will halt our execution.</li>
</ul>
</li>
</ul>
<h4 id="running-requests-concurrently-with-gather">Running requests concurrently with <code>gather</code></h4>
<ul>
<li>If an awaitable we pass in is a coroutine, <code>gather</code> will automatically wrap it in a task to ensure that it runs concurrently.</li>
<li>It returns an awaitable.</li>
<li>When we use it in an <code>await</code> expression, it will pause until all awaitables that we passed into it are complete. Then, it will return a list of the completed results.</li>
<li><code>gather</code> guarantees the results will be returned in the order we passed them in.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> aiohttp <span style="color:#f92672">import</span> ClientSession
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util <span style="color:#f92672">import</span> async_timed, fetch_status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@async_timed</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> ClientSession <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>    urls <span style="color:#f92672">=</span> [ <span style="color:#e6db74">&#39;https://example.com&#39;</span> <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1000</span>) ]
</span></span><span style="display:flex;"><span>    requests <span style="color:#f92672">=</span> [ fetch_status(session, url) <span style="color:#66d9ef">for</span> url <span style="color:#f92672">in</span> urls ] <span style="color:#75715e"># generates a list of coroutines for each request we want to make</span>
</span></span><span style="display:flex;"><span>    status_codes <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>gather(<span style="color:#f92672">*</span>requests) <span style="color:#75715e"># waits for all requests to complete</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h5 id="handling-exceptions-with-gather">Handling exceptions with <code>gather</code></h5>
<ul>
<li>
<p><code>gather</code> gives an optional parameter <code>return_exceptions</code>, which can specify how we want to deal with exceptions from our awaitables.</p>
<ul>
<li><code>return_exceptions=False</code> is the default. Both a coroutine and <code>gather</code> will throw an exception when we <code>await</code> it. Even if a coroutine is failed, our other coroutines will continue to run as long as we handle the exception, or the exception does not result in the event loop stopping and cancelling the tasks.</li>
<li><code>return_exceptions=True</code> <code>gather</code> will return any exceptions as part of the result list it returns when we await it. <code>gather</code> will not throw any exceptions itself, and we&rsquo;ll be able to handle all exceptions as we wish.</li>
</ul>
</li>
<li>
<p><strong>Drawbacks:</strong></p>
<ul>
<li>Cancelling tasks is not easy if one throws an exception.</li>
<li>Before we can process our results, we must wait for all coroutines to finish.</li>
</ul>
</li>
</ul>
<h4 id="processing-requests-as_completed">Processing requests <code>as_completed</code></h4>
<ul>
<li>It takes a list of awaitables and returns an iterator of futures. We can then iterate over these futures, awaiting each one.</li>
<li>There is no deterministic ordering of results since we have no guarantees as to which requests will complete first.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> aiohttp <span style="color:#f92672">import</span> ClientSession
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util <span style="color:#f92672">import</span> fetch_status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> ClientSession <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>    fetchers <span style="color:#f92672">=</span> [ fetch_status(session, <span style="color:#e6db74">&#39;https://www.example.com&#39;</span>, <span style="color:#ae81ff">1</span>), <span style="color:#75715e"># coroutine 1</span>
</span></span><span style="display:flex;"><span>                 fetch_status(session, <span style="color:#e6db74">&#39;https://www.example.com&#39;</span>, <span style="color:#ae81ff">1</span>), <span style="color:#75715e"># coroutine 2</span>
</span></span><span style="display:flex;"><span>                 fetch_status(session, <span style="color:#e6db74">&#39;https://www.example.com&#39;</span>, <span style="color:#ae81ff">10</span>), <span style="color:#75715e"># coroutine 3</span>
</span></span><span style="display:flex;"><span>               ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> finished_task <span style="color:#f92672">in</span> asyncio<span style="color:#f92672">.</span>as_completed(fetchers, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>):  <span style="color:#75715e"># If it takes longer than the timeout, each awaitable in the iterator will throw a TimeoutException when we await it.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> done_task
</span></span><span style="display:flex;"><span>        print(result)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">except</span> asyncio<span style="color:#f92672">.</span>TimeoutError:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;We got a timeout error&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> task <span style="color:#f92672">in</span> asyncio<span style="color:#f92672">.</span>tasks<span style="color:#f92672">.</span>all_tasks():
</span></span><span style="display:flex;"><span>        print(task)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><ul>
<li><strong>Drawbacks:</strong>
<ul>
<li>The order is completely non-deterministic.</li>
<li>While we will correctly throw an exception and move on, any tasks created will still be running in the background.</li>
</ul>
</li>
</ul>
<h4 id="finer-grained-control-with-wait">Finer-grained control with <code>wait</code></h4>
<ul>
<li>It returns two sets:
<ul>
<li>
<ol>
<li>A set of tasks that are finished with either a result or an exception.</li>
</ol>
</li>
<li>
<ol start="2">
<li>A set of tasks that are still running.</li>
</ol>
</li>
</ul>
</li>
</ul>
<h5 id="waiting-for-all-tasks-to-complete-return_whenasyncioall_completed">Waiting for all tasks to complete: <code>return_when=asyncio.ALL_COMPLETED</code></h5>
<ul>
<li>We wait until all tasks are completed before returning.</li>
<li>Handling exceptions:
<ul>
<li>
<ol>
<li>We can use <code>await</code> and let the exception be thrown and wrap it in <code>try except</code> block to handle the exception.</li>
</ol>
</li>
<li>
<ol start="2">
<li>We can use <code>task.result()</code> and <code>task.exception()</code>.</li>
</ol>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> aiohttp <span style="color:#f92672">import</span> ClientSession
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util <span style="color:#f92672">import</span> fetch_status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> ClientSession <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>    good_request <span style="color:#f92672">=</span> fetch_status(session, <span style="color:#e6db74">&#39;https://www.example.com&#39;</span>)
</span></span><span style="display:flex;"><span>    bad_request <span style="color:#f92672">=</span> fetch_status(session, <span style="color:#e6db74">&#39;python://bad&#39;</span>))
</span></span><span style="display:flex;"><span>    fetchers <span style="color:#f92672">=</span> [ asyncio<span style="color:#f92672">.</span>create_task(good_request),
</span></span><span style="display:flex;"><span>                 asyncio<span style="color:#f92672">.</span>create_task(bad_request)
</span></span><span style="display:flex;"><span>               ]
</span></span><span style="display:flex;"><span>  done, pending <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>wait(fetchers)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> done_task <span style="color:#f92672">in</span> done:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># result = await done_task will throw an exception</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> done_task<span style="color:#f92672">.</span>exception() <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>: <span style="color:#75715e"># checks to see if we have an exception</span>
</span></span><span style="display:flex;"><span>      print(done_task<span style="color:#f92672">.</span>result())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>      logging<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#34;Request got an exception&#34;</span>, exc_info<span style="color:#f92672">=</span>done_task<span style="color:#f92672">.</span>exception())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h5 id="watching-for-exceptions-return_whenasynciofirst_exception">Watching for exceptions: <code>return_when=asyncio.FIRST_EXCEPTION</code></h5>
<ul>
<li>We want to handle exceptions to ensure responsiveness.
<ul>
<li>
<ol>
<li>If there is no exception, <code>FIRST_EXCEPTION</code> equals <code>ALL_COMPLETED</code>.</li>
</ol>
</li>
<li>
<ol start="2">
<li>If any task throws an exception, <code>wait</code> will immediately return once that exception is thrown.</li>
</ol>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> aiohttp <span style="color:#f92672">import</span> ClientSession
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util <span style="color:#f92672">import</span> fetch_status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> ClientSession <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>    fetchers <span style="color:#f92672">=</span> [ asyncio<span style="color:#f92672">.</span>create_task(fetch_status(session, <span style="color:#e6db74">&#39;python://bad&#39;</span>)),
</span></span><span style="display:flex;"><span>                 asyncio<span style="color:#f92672">.</span>create_task(fetch_status(session, <span style="color:#e6db74">&#39;https://www.example.com&#39;</span>, delay<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)),
</span></span><span style="display:flex;"><span>                 asyncio<span style="color:#f92672">.</span>create_task(fetch_status(session, <span style="color:#e6db74">&#39;https://www.example.com&#39;</span>, delay<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)),
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  done, pending <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>wait(fetchers, return_when<span style="color:#f92672">=</span>asyncio<span style="color:#f92672">.</span>FIRST_EXCEPTION)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> done_task <span style="color:#f92672">in</span> done:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># result = await done_task will throw an exception</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> done_task<span style="color:#f92672">.</span>exception() <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>: <span style="color:#75715e"># checks to see if we have an exception</span>
</span></span><span style="display:flex;"><span>      print(done_task<span style="color:#f92672">.</span>result())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>      logging<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#34;Request got an exception&#34;</span>, exc_info<span style="color:#f92672">=</span>done_task<span style="color:#f92672">.</span>exception())
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> pending_task <span style="color:#f92672">in</span> pending:
</span></span><span style="display:flex;"><span>    pending_task<span style="color:#f92672">.</span>cancel()
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h5 id="processing-results-as-they-complete-return_whenasynciofirst_completed">Processing results as they complete: <code>return_when=asyncio.FIRST_COMPLETED</code></h5>
<ul>
<li>To reach the result as soon as it completes.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> aiohttp <span style="color:#f92672">import</span> ClientSession
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util <span style="color:#f92672">import</span> fetch_status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> ClientSession <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>    fetchers <span style="color:#f92672">=</span> [ asyncio<span style="color:#f92672">.</span>create_task(fetch_status(session, <span style="color:#e6db74">&#39;https://www.example.com&#39;</span>)),
</span></span><span style="display:flex;"><span>                 asyncio<span style="color:#f92672">.</span>create_task(fetch_status(session, <span style="color:#e6db74">&#39;https://www.example.com&#39;</span>)),
</span></span><span style="display:flex;"><span>                 asyncio<span style="color:#f92672">.</span>create_task(fetch_status(session, <span style="color:#e6db74">&#39;https://www.example.com&#39;</span>)),
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  done, pending <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>wait(fetchers, return_when<span style="color:#f92672">=</span>asyncio<span style="color:#f92672">.</span>FIRST_COMPLETED)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> done_task <span style="color:#f92672">in</span> done:
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> done_task
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h6 id="handling-timeouts">Handling timeouts</h6>
<ul>
<li><code>wait</code> sets timeouts to specify how long we want all awaitables to complete with <code>timeout</code> parameter. If we exceed the timeout, it returns both done and pending tasks.
<ul>
<li>
<ol>
<li><strong>Coroutines are not cancelled:</strong> We must explicitly loop over the tasks and cancel them.</li>
</ol>
</li>
<li>
<ol start="2">
<li><strong>Timeout errors are not raised:</strong>  If the timeout occurs the wait returns all tasks are done and all tasks that are still pending up to that point when the timeout occurred.</li>
</ol>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> aiohttp <span style="color:#f92672">import</span> ClientSession
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util <span style="color:#f92672">import</span> fetch_status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> ClientSession <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>    fetchers <span style="color:#f92672">=</span> [ asyncio<span style="color:#f92672">.</span>create_task(fetch_status(session, <span style="color:#e6db74">&#39;https://www.example.com&#39;</span>)),
</span></span><span style="display:flex;"><span>                 asyncio<span style="color:#f92672">.</span>create_task(fetch_status(session, <span style="color:#e6db74">&#39;https://www.example.com&#39;</span>)),
</span></span><span style="display:flex;"><span>                 asyncio<span style="color:#f92672">.</span>create_task(fetch_status(session, <span style="color:#e6db74">&#39;https://www.example.com&#39;</span>, delay<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)),
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  done, pending <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>wait(fetchers, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> done_task <span style="color:#f92672">in</span> done:
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> done_task
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><ul>
<li>Tasks in the pending set are not cancelled and will continue to run despite the timeout.</li>
<li>If we want to terminate the pending tasks, we explicitly loop through the pending set and call cancel on each task.</li>
</ul>
<hr>
<h2 id="async-delay-app">async delay app</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> shutil
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> tty
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncio <span style="color:#f92672">import</span> StreamReader
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> deque
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Callable, Deque, Awaitable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_stdin_reader</span>() <span style="color:#f92672">-&gt;</span> StreamReader:
</span></span><span style="display:flex;"><span> stream_reader <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>StreamReader()
</span></span><span style="display:flex;"><span> protocol <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>StreamReaderProtocol(stream_reader)
</span></span><span style="display:flex;"><span> loop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_running_loop()
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">await</span> loop<span style="color:#f92672">.</span>connect_read_pipe(<span style="color:#66d9ef">lambda</span>: protocol, sys<span style="color:#f92672">.</span>stdin)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> stream_reader
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_line</span>(stdin_reader: StreamReader) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">erase_last_char</span>():
</span></span><span style="display:flex;"><span>  move_back_one_char()
</span></span><span style="display:flex;"><span>  sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39; &#39;</span>)
</span></span><span style="display:flex;"><span>  move_back_one_char()
</span></span><span style="display:flex;"><span> delete_char <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x7f</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span> input_buffer <span style="color:#f92672">=</span> deque()
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">while</span> ( input_char <span style="color:#f92672">:=</span> <span style="color:#66d9ef">await</span> stdin_reader<span style="color:#f92672">.</span>read(<span style="color:#ae81ff">1</span>)) <span style="color:#f92672">!=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> input_char <span style="color:#f92672">==</span> delete_char:
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> len(input_buffer) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>    input_buffer<span style="color:#f92672">.</span>pop()
</span></span><span style="display:flex;"><span>    erase_last_char()
</span></span><span style="display:flex;"><span>    sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>   input_buffer<span style="color:#f92672">.</span>append(input_char)
</span></span><span style="display:flex;"><span>   sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(input_char<span style="color:#f92672">.</span>decode())
</span></span><span style="display:flex;"><span>   sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span> clear_line()
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(input_buffer)<span style="color:#f92672">.</span>decode()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MessageStore</span>:
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> __init__(self, callback: Callable[[Deque], Awaitable[<span style="color:#66d9ef">None</span>]], max_size: int):
</span></span><span style="display:flex;"><span>  self<span style="color:#f92672">.</span>_deque <span style="color:#f92672">=</span> deque(maxlen<span style="color:#f92672">=</span>max_size)
</span></span><span style="display:flex;"><span>  self<span style="color:#f92672">.</span>_callback <span style="color:#f92672">=</span> callback
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">append</span>(self, item):
</span></span><span style="display:flex;"><span>  self<span style="color:#f92672">.</span>_deque<span style="color:#f92672">.</span>append(item)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_callback(self<span style="color:#f92672">.</span>_deque)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">save_cursor_position</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">7&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">restore_cursor_position</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">8&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">move_to_bottom_of_screen</span>() <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span> _, total_rows <span style="color:#f92672">=</span> shutil<span style="color:#f92672">.</span>get_terminal_size()
</span></span><span style="display:flex;"><span> input_row <span style="color:#f92672">=</span> total_rows <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[</span><span style="color:#e6db74">{</span>input_row<span style="color:#e6db74">}</span><span style="color:#e6db74">E&#39;</span>)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> total_rows
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">move_to_top_of_screen</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[H&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">move_back_one_char</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[1D&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_line</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[2K&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">clear_line</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[2K</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[0G&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sleep</span>(delay: int, message_store: MessageStore):
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">await</span> message_store<span style="color:#f92672">.</span>append(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Starting delay </span><span style="color:#e6db74">{</span>delay<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(delay)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">await</span> message_store<span style="color:#f92672">.</span>append(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Finished delay </span><span style="color:#e6db74">{</span>delay<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span> tty<span style="color:#f92672">.</span>setcbreak(sys<span style="color:#f92672">.</span>stdin)
</span></span><span style="display:flex;"><span> os<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#39;clear&#39;</span>)
</span></span><span style="display:flex;"><span> rows <span style="color:#f92672">=</span> move_to_bottom_of_screen()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">redraw_output</span>(items: deque):
</span></span><span style="display:flex;"><span>  save_cursor_position()
</span></span><span style="display:flex;"><span>  move_to_top_of_screen()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> items:
</span></span><span style="display:flex;"><span>   delete_line()
</span></span><span style="display:flex;"><span>   print(item)
</span></span><span style="display:flex;"><span>  restore_cursor_position()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> messages <span style="color:#f92672">=</span> MessageStore(redraw_output, rows<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> stdin_reader <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> create_stdin_reader()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>  line <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> read_line(stdin_reader)
</span></span><span style="display:flex;"><span>  delay_time <span style="color:#f92672">=</span> int(line)
</span></span><span style="display:flex;"><span>  asyncio<span style="color:#f92672">.</span>create_task(sleep(delay_time, messages))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><hr>
<h2 id="asyncgenerator">AsyncGenerator</h2>
<ul>
<li>An async generator can be annotated by the generic type <code>AsyncGenerator[YieldType, SendType]</code>. For example,</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">echo_round</span>() <span style="color:#f92672">-&gt;</span> AsyncGenerator[int, float]:
</span></span><span style="display:flex;"><span>    sent <span style="color:#f92672">=</span> <span style="color:#66d9ef">yield</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> sent <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0.0</span>:
</span></span><span style="display:flex;"><span>        rounded <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> round(sent)
</span></span><span style="display:flex;"><span>        sent <span style="color:#f92672">=</span> <span style="color:#66d9ef">yield</span> rounded
</span></span></code></pre></div><ul>
<li>Unlike normal generators, async generators cannot return a value, so there is no ReturnType type parameter.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">coroutine_method</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generator_method</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">yield</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This is correct</span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> coroutine_method()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This will raise an exception!</span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> generator_method()
</span></span></code></pre></div><hr>
<h2 id="async-input-reader">async input reader</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util.delay <span style="color:#f92672">import</span> delay
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util.create_stdin_reader <span style="color:#f92672">import</span> create_stdin_reader
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  stdin_reader <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> create_stdin_reader()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>    delay_time <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> stdin_reader<span style="color:#f92672">.</span>readline()
</span></span><span style="display:flex;"><span>    asyncio<span style="color:#f92672">.</span>create_task(delay(int(delay_time)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><hr>
<h2 id="awaitables">Awaitables</h2>
<p><img src="/img/awaitables.png" alt="awaitables"></p>
<ul>
<li>
<p>When you call <code>await</code> you must call it on one of the following:</p>
</li>
<li>
<p><strong>A coroutine object</strong>, which is the return value of a coroutine function defined using async def.</p>
<ul>
<li>The coroutine’s code will only be executed when it is awaited or wrapped in a task.</li>
</ul>
</li>
<li>
<p><strong>A future object</strong>, which represents a process ongoing somewhere else which may have finished.</p>
<ul>
<li>Awaiting a future will not cause code to be executed, but might pause your current task until another process has been completed.</li>
</ul>
</li>
<li>
<p><strong>An object which implements the <code>__await__</code> magic method</strong></p>
<ul>
<li>What happens then could be anything, check the documentation for the object in question.</li>
</ul>
</li>
</ul>
<hr>
<h2 id="web-applications">Web Applications</h2>
<h3 id="creating-web-applications-with-aiohttpaiohttpmd">Creating web applications with <a href="../aiohttp.md" ><code>aiohttp</code></a>
</h3>
<ul>
<li>Build async <a href="../../api/rest_api.md" >REST API</a>
s with <a href="../aiohttp.md" ><code>aiohttp</code></a>
</li>
</ul>
<h4 id="web-module-of-aiohttp"><code>web</code> module of <code>aiohttp</code></h4>
<ul>
<li>We can define <em>endpoints(routes)</em> with a <code>RouteTableDef</code>.
<ul>
<li>A <code>RouteTableDef</code> provides a decorator that lets us specify a request type (GET, POST, etc.) and a string representing the endpoint name.</li>
</ul>
</li>
</ul>
<h3 id="asgi">ASGI</h3>
<h3 id="creating-asgi-web-applications-with-starlette">Creating ASGI web applications with Starlette</h3>
<ul>
<li>Build a simple REST API with WebSocket support</li>
</ul>
<h3 id="using-djangos-asynchronous-views">Using Django&rsquo;s asynchronous views</h3>
<hr>
<h2 id="event-loop-1">Event loop</h2>
<ul>
<li>It manages the execution of a set of Python functions and switches between them as they block and unblock.</li>
<li>An event loop contains within a list of object calls called <code>Task</code>s.</li>
<li>At any one time the event loop can only have one Task executing, whilst the other tasks in the loop are all paused.</li>
<li>An event loop cannot forcibly interrupt a coroutine that is currently executing. A coroutine that is executing will continue executing until it yields control. The event loop serves to select which coroutine to schedule next and keeps track of which coroutines are blocked and unable to execute until some IO has been completed, but it only does these things when no coroutine is currently executing.</li>
</ul>
<h3 id="use-asyncios-non-blocking-socket-coroutines-to-allow-multi-clients-to-connect-properly">Use <code>asyncio</code>&rsquo;s non-blocking socket coroutines to allow multi-clients to connect properly</h3>
<ul>
<li>
<p>When an event loop is triggered by either</p>
<ul>
<li>a socket event happening or</li>
<li>a timeout triggering an iteration of the loop,
waiting for coroutines will run until complete or hit the next <code>await</code> statement.</li>
</ul>
</li>
<li>
<p>When we hit an <code>await</code> in a coroutine that utilizes a non-blocking socket, it will register that socket with the system&rsquo;s selector and keep track that the coroutine is paused waiting for a result.</p>
</li>
</ul>
<h3 id="event-loop-coroutines-for-sockets">Event loop coroutines for sockets</h3>
<ul>
<li>They take in a socket and <code>await</code> until we have data to act on.</li>
</ul>
<h4 id="1-sock_accept">1. <code>sock_accept</code></h4>
<ul>
<li><code>connection, address = await loop.sock_accept(socket)</code> is analogous to <code>socket.accept</code> and will <code>await</code> the coroutine that it returns.</li>
<li>It returns a tuple of a socket connection and a client address.</li>
</ul>
<h4 id="2-sock_recv">2. <code>sock_recv</code></h4>
<ul>
<li><code>data = await loop.sock_recv(socket)</code> will <code>await</code> until a socket has bytes we can process.</li>
</ul>
<h4 id="3-sock_sendall">3. <code>sock_sendall</code></h4>
<ul>
<li><code>success = await loop.sock_sendall(socket, data)</code> will wait until all data we want to send to a socket has been sent and will return <code>None</code> on success.</li>
</ul>
<hr>
<h2 id="chat-client">chat client</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> tty
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncio <span style="color:#f92672">import</span> StreamReader, StreamWriter
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> deque
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util <span style="color:#f92672">import</span> create_stdin_reader, cursor, message_store
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util.message_store <span style="color:#f92672">import</span> MessageStore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_and_send</span>(message: str, writer: StreamWriter):
</span></span><span style="display:flex;"><span>  writer<span style="color:#f92672">.</span>write((message <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> writer<span style="color:#f92672">.</span>drain()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">listen_for_messages</span>(reader: StreamReader, message_store: MessageStore):
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (message <span style="color:#f92672">:=</span> <span style="color:#66d9ef">await</span> reader<span style="color:#f92672">.</span>readline()) <span style="color:#f92672">!=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> message_store<span style="color:#f92672">.</span>append(message<span style="color:#f92672">.</span>decode())
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> message_store<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;Server closed connection&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  tty<span style="color:#f92672">.</span>setcbreak(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>  os<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#39;clear&#39;</span>)
</span></span><span style="display:flex;"><span>  rows <span style="color:#f92672">=</span> cursor<span style="color:#f92672">.</span>move_to_bottom_of_screen()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">redraw_output</span>(items: deque):
</span></span><span style="display:flex;"><span>    cursor<span style="color:#f92672">.</span>save_cursor_position()
</span></span><span style="display:flex;"><span>    cursor<span style="color:#f92672">.</span>move_to_top_of_screen()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> items:
</span></span><span style="display:flex;"><span>      cursor<span style="color:#f92672">.</span>delete_line()
</span></span><span style="display:flex;"><span>      print(item)
</span></span><span style="display:flex;"><span>    cursor<span style="color:#f92672">.</span>restore_cursor_position()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  messages <span style="color:#f92672">=</span> MessageStore(redraw_output, rows<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>  stdin_reader <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> create_stdin_reader<span style="color:#f92672">.</span>create_stdin_reader()
</span></span><span style="display:flex;"><span>  sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;Enter username: &#39;</span>)
</span></span><span style="display:flex;"><span>  username <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> cursor<span style="color:#f92672">.</span>read_line(stdin_reader)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  reader, writer <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>open_connection(<span style="color:#e6db74">&#39;127.0.0.1&#39;</span>, <span style="color:#ae81ff">8000</span>)
</span></span><span style="display:flex;"><span>  writer<span style="color:#f92672">.</span>write(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;CONNECT </span><span style="color:#e6db74">{</span>username<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> writer<span style="color:#f92672">.</span>drain()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  message_listener <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(listen_for_messages(reader, messages))
</span></span><span style="display:flex;"><span>  input_listener <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(read_and_send(stdinreader, writer))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>wait([message_listener, input_listener], return_when<span style="color:#f92672">=</span>asyncio<span style="color:#f92672">.</span>FIRST_COMPLETED)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>    logging<span style="color:#f92672">.</span>exception(e)
</span></span><span style="display:flex;"><span>    writer<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> writer<span style="color:#f92672">.</span>wait_closed()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><hr>
<h2 id="chat-server">chat server</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncio <span style="color:#f92672">import</span> StreamReader, StreamWriter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ChatServer</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>_username_to_writer <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start_chat_server</span>(self, host: str, port: int):
</span></span><span style="display:flex;"><span>    server <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>start_server(self<span style="color:#f92672">.</span>client_connected, host, port)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> server:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> server<span style="color:#f92672">.</span>serve_forever()
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">client_connected</span>(self, reader: StreamReader, writer: StreamWriter):
</span></span><span style="display:flex;"><span>    command <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> reader<span style="color:#f92672">.</span>readline()
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;CONNECTED </span><span style="color:#e6db74">{</span>reader<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>writer<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    command, args <span style="color:#f92672">=</span> command<span style="color:#f92672">.</span>split(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39; &#39;</span>)
</span></span><span style="display:flex;"><span>    print(command)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># print(args)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> command <span style="color:#f92672">==</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;CONNECT&#39;</span>:
</span></span><span style="display:flex;"><span>      username <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>)<span style="color:#f92672">.</span>decode()
</span></span><span style="display:flex;"><span>      self<span style="color:#f92672">.</span>_add_user(username, reader, writer)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_on_connect(username, writer)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>      logging<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#39;Got invalid command from client, disconnecting.&#39;</span>)
</span></span><span style="display:flex;"><span>      writer<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> writer<span style="color:#f92672">.</span>wait_closed()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_add_user</span>(self, username: str, reader: StreamReader, writer: StreamWriter):
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>_username_to_writer[username] <span style="color:#f92672">=</span> writer
</span></span><span style="display:flex;"><span>    asyncio<span style="color:#f92672">.</span>create_task(self<span style="color:#f92672">.</span>_listen_for_messages(username, reader))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_remove_user</span>(self, username: str):
</span></span><span style="display:flex;"><span>    writer <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_username_to_writer[username]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>_username_to_writer[username]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>      writer<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> writer<span style="color:#f92672">.</span>wait_closed()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>      logging<span style="color:#f92672">.</span>exception(<span style="color:#e6db74">&#39;Error closing client writer, ignoring.&#39;</span>, exc_info<span style="color:#f92672">=</span>e)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_notify_all</span>(self, message: str):
</span></span><span style="display:flex;"><span>    inactive_users <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> username, writer <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_username_to_writer<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        writer<span style="color:#f92672">.</span>write(message<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> writer<span style="color:#f92672">.</span>drain()
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ConnectionError</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logging<span style="color:#f92672">.</span>exception(<span style="color:#e6db74">&#39;Could not write to client.&#39;</span>, exc_info<span style="color:#f92672">=</span>e)
</span></span><span style="display:flex;"><span>        inactive_users<span style="color:#f92672">.</span>append(username)
</span></span><span style="display:flex;"><span>    [ <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_remove_user(username) <span style="color:#66d9ef">for</span> username <span style="color:#f92672">in</span> inactive_users ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_listen_for_messages</span>(self, username: str, reader: StreamReader):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">while</span> (data <span style="color:#f92672">:=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>wait_for(reader<span style="color:#f92672">.</span>readline(), <span style="color:#ae81ff">60</span>)) <span style="color:#f92672">!=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_notify_all(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>username<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>data<span style="color:#f92672">.</span>decode()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_notify_all(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>username<span style="color:#e6db74">}</span><span style="color:#e6db74"> has left the chat</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>      logging<span style="color:#f92672">.</span>exception(<span style="color:#e6db74">&#39;Error reading from client.&#39;</span>, exc_info<span style="color:#f92672">=</span>e)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_remove_user(username)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_on_connect</span>(self, username: str, writer: StreamWriter):
</span></span><span style="display:flex;"><span>    writer<span style="color:#f92672">.</span>write(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Welcome! </span><span style="color:#e6db74">{</span>len(self<span style="color:#f92672">.</span>_username_to_writer)<span style="color:#e6db74">}</span><span style="color:#e6db74"> user(s) are online!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> writer<span style="color:#f92672">.</span>drain()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_notify_all(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>username<span style="color:#e6db74">}</span><span style="color:#e6db74"> connected!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  chat_server <span style="color:#f92672">=</span> ChatServer()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> chat_server<span style="color:#f92672">.</span>start_chat_server(<span style="color:#e6db74">&#39;127.0.0.1&#39;</span>, <span style="color:#ae81ff">8000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><hr>
<h2 id="cli-sql">cli sql</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">## The code creates some errors</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncpg
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> shutil
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> tty
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> deque
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncio <span style="color:#f92672">import</span> StreamReader
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncpg <span style="color:#f92672">import</span> Pool
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Callable, Deque, Awaitable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_stdin_reader</span>() <span style="color:#f92672">-&gt;</span> StreamReader:
</span></span><span style="display:flex;"><span> stream_reader <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>StreamReader()
</span></span><span style="display:flex;"><span> protocol <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>StreamReaderProtocol(stream_reader)
</span></span><span style="display:flex;"><span> loop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_running_loop()
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">await</span> loop<span style="color:#f92672">.</span>connect_read_pipe(<span style="color:#66d9ef">lambda</span>: protocol, sys<span style="color:#f92672">.</span>stdin)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> stream_reader
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MessageStore</span>:
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> __init__(self, callback: Callable[[Deque], Awaitable[<span style="color:#66d9ef">None</span>]], max_size: int):
</span></span><span style="display:flex;"><span>  self<span style="color:#f92672">.</span>_deque <span style="color:#f92672">=</span> deque(maxlen<span style="color:#f92672">=</span>max_size)
</span></span><span style="display:flex;"><span>  self<span style="color:#f92672">.</span>_callback <span style="color:#f92672">=</span> callback
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">append</span>(self, item):
</span></span><span style="display:flex;"><span>  self<span style="color:#f92672">.</span>_deque<span style="color:#f92672">.</span>append(item)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_callback(self<span style="color:#f92672">.</span>_deque)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">save_cursor_position</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">7&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">restore_cursor_position</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">8&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">move_to_bottom_of_screen</span>() <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span> _, total_rows <span style="color:#f92672">=</span> shutil<span style="color:#f92672">.</span>get_terminal_size()
</span></span><span style="display:flex;"><span> input_row <span style="color:#f92672">=</span> total_rows <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[</span><span style="color:#e6db74">{</span>input_row<span style="color:#e6db74">}</span><span style="color:#e6db74">E&#39;</span>)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> total_rows
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">move_to_top_of_screen</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[H&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">move_back_one_char</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[1D&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_line</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[2K&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">clear_line</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[2K</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[0G&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_query</span>(query: str, pool: Pool, message_store: MessageStore):
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> pool<span style="color:#f92672">.</span>acquire() <span style="color:#66d9ef">as</span> connection:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>   result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>fetchrow(query)
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">await</span> message_store<span style="color:#f92672">.</span>append(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Fetched </span><span style="color:#e6db74">{</span>len(result)<span style="color:#e6db74">}</span><span style="color:#e6db74"> rows from: </span><span style="color:#e6db74">{</span>query<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">await</span> message_store<span style="color:#f92672">.</span>append(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Got exception </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">: from </span><span style="color:#e6db74">{</span>query<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_line</span>(stdin_reader: StreamReader) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">erase_last_char</span>():
</span></span><span style="display:flex;"><span>  move_back_one_char()
</span></span><span style="display:flex;"><span>  sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39; &#39;</span>)
</span></span><span style="display:flex;"><span>  move_back_one_char()
</span></span><span style="display:flex;"><span> delete_char <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x7f</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span> input_buffer <span style="color:#f92672">=</span> deque()
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">while</span> ( input_char <span style="color:#f92672">:=</span> <span style="color:#66d9ef">await</span> stdin_reader<span style="color:#f92672">.</span>read(<span style="color:#ae81ff">1</span>)) <span style="color:#f92672">!=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> input_char <span style="color:#f92672">==</span> delete_char:
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> len(input_buffer) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>    input_buffer<span style="color:#f92672">.</span>pop()
</span></span><span style="display:flex;"><span>    erase_last_char()
</span></span><span style="display:flex;"><span>    sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>   input_buffer<span style="color:#f92672">.</span>append(input_char)
</span></span><span style="display:flex;"><span>   sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(input_char<span style="color:#f92672">.</span>decode())
</span></span><span style="display:flex;"><span>   sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span> clear_line()
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(input_buffer)<span style="color:#f92672">.</span>decode()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span> tty<span style="color:#f92672">.</span>setcbreak(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span> os<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#39;clear&#39;</span>)
</span></span><span style="display:flex;"><span> rows <span style="color:#f92672">=</span> move_to_bottom_of_screen()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">redraw_output</span>(items: deque):
</span></span><span style="display:flex;"><span>  save_cursor_position()
</span></span><span style="display:flex;"><span>  move_to_top_of_screen()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> items:
</span></span><span style="display:flex;"><span>   delete_line()
</span></span><span style="display:flex;"><span>   print(item)
</span></span><span style="display:flex;"><span>  restore_cursor_position()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> messages <span style="color:#f92672">=</span> MessageStore(redraw_output, rows <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span> stdin_reader <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> create_stdin_reader()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> asyncpg<span style="color:#f92672">.</span>create_pool( host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>         port<span style="color:#f92672">=</span><span style="color:#ae81ff">5432</span>,
</span></span><span style="display:flex;"><span>         user<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;postgres&#39;</span>,
</span></span><span style="display:flex;"><span>         password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span>,
</span></span><span style="display:flex;"><span>         database<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;products&#39;</span>,
</span></span><span style="display:flex;"><span>         min_size<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>,
</span></span><span style="display:flex;"><span>         max_size<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>) <span style="color:#66d9ef">as</span> pool:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>   query <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> read_line(stdin_reader)
</span></span><span style="display:flex;"><span>   asyncio<span style="color:#f92672">.</span>create_task(run_query(query, pool, messages))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><hr>
<h2 id="designing-an-asyncio-echo-server">Designing an <code>asyncio</code> echo server</h2>
<ul>
<li><code>listen_for_connections</code> coroutine will loop forever and listen for any incoming connections.</li>
<li>It will allow other code to run concurrently, while we’re paused and waiting for a connection.</li>
<li>We need to handle multiple connections to read and write at the same time so we create a task for each connection.</li>
<li>When we await a task that failed, the exception will get thrown where we perform the await, and the traceback will reflect that.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> signal
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncio <span style="color:#f92672">import</span> AbstractEventLoop
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> List
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">echo</span>(connection: socket, loop: AbstractEventLoop) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> data <span style="color:#f92672">:=</span> <span style="color:#66d9ef">await</span> loop<span style="color:#f92672">.</span>sock_recv(connection, <span style="color:#ae81ff">1024</span>): <span style="color:#75715e"># loop forever waiting for data from a client connection</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> data <span style="color:#f92672">==</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;boom</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#34;Unexpected network error&#34;</span>) <span style="color:#75715e"># a line from the output: Task exception was never retrieved</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># no exception is thrown to call stack and no cleanup here `await` is required</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> loop<span style="color:#f92672">.</span>sock_sendall(connection, data)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> ex:
</span></span><span style="display:flex;"><span>    logging<span style="color:#f92672">.</span>exception(ex)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">finally</span>:
</span></span><span style="display:flex;"><span>    connection<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo_tasks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">connection_listener</span>(server_socket: socket, loop: AbstractEventLoop) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>    connection, address <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> loop<span style="color:#f92672">.</span>sock_accept(server_socket)
</span></span><span style="display:flex;"><span>    connection<span style="color:#f92672">.</span>setblocking(<span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Got a connection from </span><span style="color:#e6db74">{</span>address<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    echo_task <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(echo(connection, loop)) <span style="color:#75715e"># whenever we get a connection, create an echo task to listen for client data</span>
</span></span><span style="display:flex;"><span>    echo_tasks<span style="color:#f92672">.</span>append(echo_task)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GracefulExit</span>(<span style="color:#a6e22e">SystemExit</span>):
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">shutdown</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">raise</span> GracefulExit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">close_echo_tasks</span>(echo_tasks: List[asyncio<span style="color:#f92672">.</span>Task]) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  waiters <span style="color:#f92672">=</span> [asyncio<span style="color:#f92672">.</span>wait_for(task, <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">for</span> task <span style="color:#f92672">in</span> echo_tasks] <span style="color:#75715e"># `asyncio.wait_for` sets timeouts on a task</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> task <span style="color:#f92672">in</span> waiters:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> task
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> asyncio<span style="color:#f92672">.</span>exceptions<span style="color:#f92672">.</span>TimeoutError:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  server_socket <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket()
</span></span><span style="display:flex;"><span>  server_socket<span style="color:#f92672">.</span>setsockopt(socket<span style="color:#f92672">.</span>SOL_SOCKET, socket<span style="color:#f92672">.</span>SO_REUSEADDR, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  server_address <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;127.0.0.1&#39;</span>, <span style="color:#ae81ff">8000</span>)
</span></span><span style="display:flex;"><span>  server_socket<span style="color:#f92672">.</span>setblocking(<span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>  server_socket<span style="color:#f92672">.</span>bind(server_address)
</span></span><span style="display:flex;"><span>  server_socket<span style="color:#f92672">.</span>listen()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> signame <span style="color:#f92672">in</span> [ <span style="color:#e6db74">&#39;SIGINT&#39;</span>, <span style="color:#e6db74">&#39;SIGTERM&#39;</span> ]:
</span></span><span style="display:flex;"><span>    loop<span style="color:#f92672">.</span>add_signal_handler(getattr(signal, signame), shutdown) <span style="color:#75715e"># listen to the event, it can safely interact with the event loop</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> connection_listener(server_socket, loop)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>new_event_loop() <span style="color:#75715e"># create a new event loop</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>  loop<span style="color:#f92672">.</span>run_until_complete(main()) <span style="color:#75715e"># take a coroutine and run it until it finishes</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> GracefulExit:
</span></span><span style="display:flex;"><span>  loop<span style="color:#f92672">.</span>run_until_complete(close_echo_tasks(echo_tasks))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">finally</span>:
</span></span><span style="display:flex;"><span>  loop<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><hr>
<h2 id="requests"><code>requests</code></h2>
<ul>
<li>This library abstracts away the complexities of making HTTP requests.</li>
<li>It does not perform well with <code>asyncio</code> because it uses blocking sockets.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># `response` is a `Response` object, with which we can get
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># all the information we need from this object.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># `GET` retrieves resources from a given API. It is read-only.</span>
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;&lt;url&gt;&#39;</span>) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># `HEAD` asks for a response identical to that of `GET`,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># but only returns the status_code or HTTP header.</span>
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>head(<span style="color:#e6db74">&#39;&lt;url&gt;&#39;</span>)
</span></span><span style="display:flex;"><span>response<span style="color:#f92672">.</span>status_code <span style="color:#75715e"># 200</span>
</span></span><span style="display:flex;"><span>response<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#34;Content-Type&#34;</span>] <span style="color:#75715e"># &#39;application/json; charset=utf-8&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># `POST` creates a new resource.</span>
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#39;&lt;url&gt;&#39;</span>, data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;key&#39;</span>:<span style="color:#e6db74">&#39;value&#39;</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># `PUT` updates an existing resource.</span>
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>put(<span style="color:#e6db74">&#39;&lt;url&gt;&#39;</span>, data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;key&#39;</span>:<span style="color:#e6db74">&#39;value&#39;</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># `DELETE` deletes a resource.</span>
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>delete(<span style="color:#e6db74">&#39;&lt;url&gt;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># `OPTIONS` sends a `OPTIONS` request.</span>
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>options(<span style="color:#e6db74">&#39;&lt;url&gt;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># `PATCH` partially updates an existing resource.</span>
</span></span><span style="display:flex;"><span>responce <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>patch(<span style="color:#e6db74">&#39;&lt;url&gt;&#39;</span>, params<span style="color:#f92672">=</span>{<span style="color:#f92672">&lt;</span>key<span style="color:#f92672">&gt;</span>: <span style="color:#f92672">&lt;</span>value<span style="color:#f92672">&gt;</span>}, <span style="color:#f92672">&lt;</span>args<span style="color:#f92672">&gt;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Passing parameters in URLs</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;key1&#39;</span>: <span style="color:#e6db74">&#39;value1&#39;</span>, <span style="color:#e6db74">&#39;key2&#39;</span>: [<span style="color:#e6db74">&#39;value2&#39;</span>, <span style="color:#e6db74">&#39;value3&#39;</span>]}
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;httpbin.org/get?key=val&#39;</span>, params<span style="color:#f92672">=</span>payload)
</span></span><span style="display:flex;"><span>print(r<span style="color:#f92672">.</span>url) <span style="color:#75715e"># httpbin.org/get?key1=value1&amp;key2=value2&amp;key2=value3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Response content</span>
</span></span><span style="display:flex;"><span>print(response<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encoding of the response based on the HTTP headers</span>
</span></span><span style="display:flex;"><span>response<span style="color:#f92672">.</span>encoding <span style="color:#75715e"># &#39;utf-8&#39;</span>
</span></span><span style="display:flex;"><span>response<span style="color:#f92672">.</span>encoding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ISO-8859-1&#39;</span> <span style="color:#75715e"># changes the encoding</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># JSON response content</span>
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;&lt;url&gt;&#39;</span>)
</span></span><span style="display:flex;"><span>response<span style="color:#f92672">.</span>json() <span style="color:#75715e"># If decoding fails, it raises an exception.</span>
</span></span></code></pre></div><ul>
<li><code>JSON</code> is a data format of which format is similar to a key-value store in a Python dictionary. It’s the <em>defacto</em> interchange format for most REST APIs.</li>
</ul>
<h3 id="status-codes">Status codes</h3>
<ul>
<li>Status codes are numbered based on the category of the result.</li>
</ul>
<p>Code  Meaning                 Description
<strong>2xx Successful operation</strong>
200   OK                      The requested action was successful.
201   Created                 A new resource was created.
202   Accepted                The request was received, but no modification has been made yet.
204   No Content              The request was successful, but the response has no content.
<strong>3xx Redirection</strong>
<strong>4xx Client error</strong>
400   Bad Request             The request was malformed.
401   Unauthorized            The client is not authorized to perform the requested action.
404   Not Found               The requested resource was not found.
415   Unsupported Media Type  The request data format is not supported by the server.
422   Unprocessable Entity    The request data was properly formatted but contained invalid or missing data.
<strong>5xx Server error</strong>
500   Internal Server Error   The server threw an error when processing the request.</p>
<h3 id="session-objects">Session Objects</h3>
<ul>
<li>
<p>It allows you to</p>
<ul>
<li>persist certain parameters across requests.</li>
<li>persist cookies across all the requests made from the Session instance.</li>
</ul>
</li>
<li>
<p>If you are making several requests to the same host, the underlying TCP connection will be reused.</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> requests.exceptions <span style="color:#f92672">import</span> HTTPError
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> url <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;https://api.github.com&#39;</span>, <span style="color:#e6db74">&#39;https://api.github.com/invalid&#39;</span>]:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
</span></span><span style="display:flex;"><span>    response<span style="color:#f92672">.</span>raise_for_status() <span style="color:#75715e"># it will be raised in case of an error</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">except</span> HTTPError <span style="color:#66d9ef">as</span> http_err:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;HTTP error occurred: </span><span style="color:#e6db74">{</span>http_err<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> err:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Other error occurred: </span><span style="color:#e6db74">{</span>err<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;Success&#39;</span>)
</span></span></code></pre></div><hr>
<h2 id="build-socket-based-network-applications-with-asyncio-that-can-handle-multi-client-simultaneously-with-one-thread">Build socket-based network applications with <code>asyncio</code> that can handle multi-client simultaneously with one thread</h2>
<ul>
<li>A socket allows multiple users to connect simultaneously, letting them send and receive messages concurrently.</li>
</ul>
<h3 id="1-starting-a-server-and-listening-for-a-connection">1. Starting a server and listening for a connection</h3>
<h3 id="2-reading-and-writing-data-to-and-from-a-socket">2. Reading and writing data to and from a socket</h3>
<ul>
<li><code>recv</code> gets data from a particular socket.
<ul>
<li>It takes an <code>int</code> representing the number of bytes we wish to read at a given time.</li>
<li>We can&rsquo;t read all data from a socket at once; we need to buffer until we reach the end of the input.</li>
</ul>
</li>
<li>We&rsquo;ll treat the end of input as a carriage return plus a line feed or <code>'\r\n'</code>. This is what gets appended to the input when a user presses <code>[Enter]</code> in <code>telnet</code>.</li>
</ul>
<h3 id="3-build-a-multi-client-echo-server-using-non-blocking-sockets-and-os-event-notification-system">3. Build a multi-client echo server using non-blocking sockets and OS&rsquo; event notification system</h3>
<ul>
<li>
<p>It will work properly for more than one client at a time with only a single thread.</p>
</li>
<li>
<p>Steps</p>
<ol>
<li>We loop forever, calling <code>socket.accept</code> to listen for new connections.</li>
<li>Each time we get one, we append it to a list of connections we&rsquo;ve got so far.</li>
<li>We loop over each connection, receiving data as it comes in and writing that data back out to the client connection.</li>
</ol>
</li>
<li>
<p>Once the first client connects, we will block waiting for it to send its first echo message to us. This causes other clients to be stuck waiting for the next iteration of the loop, which won&rsquo;t happen until the first client sends us data.</p>
</li>
<li>
<p>When we mark a socket as non-blocking, <code>server_socket.setblocking(False)</code>, its methods will not block waiting to receive data before moving on to execute the next line of code.</p>
<ul>
<li>If the socket has data ready for processing, then we will get data returned as we would with a blocking socket.</li>
<li>If not, the socket will instantly let us know it does not have any data ready, and we are free to move on to execute other code.</li>
</ul>
</li>
<li>
<p>A <code>BlockingIOError</code> may be thrown when our server socket has no connection yet and therefore no data to process.</p>
</li>
</ul>
<h3 id="4-use-the-selectors-module-to-build-a-socket-event-loop">4. Use the <code>selectors</code> module to build a socket event loop</h3>
<ul>
<li>
<p>We give a list of sockets we want to monitor for events, and instead of constantly checking each socket to see if it has data, the OS tells us explicitly when sockets have data.</p>
</li>
<li>
<p><code>selectors</code> allows high-level and efficient I/O multiplexing.</p>
</li>
<li>
<p><code>BaseSelector</code> can be used to wait for I/O readiness notifications on multiple file objects.</p>
<ul>
<li><code>register</code> registers the file object to monitor, when we have a socket that we&rsquo;re interested in getting notifications about.</li>
<li><code>unregister</code> unregisters a file object from selection, removing it from monitoring.</li>
<li><code>select</code> wait until some registered file objects become ready, or the timeout expires.</li>
</ul>
</li>
<li>
<p><code>DefaultSelector</code> is an alias to the most efficient implementation available on the current system.</p>
</li>
<li>
<p>Working with <code>selectors</code> is a bit too low-level for most applications.</p>
</li>
</ul>
<h3 id="5-add-custom-shutdown-logic">5. Add custom shutdown logic</h3>
<ul>
<li>To implement custom shutdown logic, we&rsquo;ll implement listeners in our application for both the <code>SIGINT</code> and <code>SIGTERM</code> signals.</li>
</ul>
<h4 id="51-listening-for-signals">5.1. Listening for signals</h4>
<ul>
<li>
<p>To implement custom shutdown logic, we will implement listeners for both:</p>
<ul>
<li>
<ol>
<li><code>SIGINT</code>:= signal interrupt</li>
</ol>
<ul>
<li>In python, we can catch it by <code>KeyboardInterrupt</code>.</li>
</ul>
</li>
<li>
<ol start="2">
<li><code>SIGTERM</code> := signal terminate</li>
</ol>
<ul>
<li>It is triggered when we run <code>kill</code> on a process.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>We can directly listen for signals with the <code>add_signal_handler</code> method, which can safely interact with the event loop.</p>
</li>
<li>
<p><code>asyncio.all_tasks()</code> returns a set of all running tasks.</p>
</li>
<li>
<p>When we run this application, we&rsquo;ll see that our delay coroutine starts right away and waits for 10 seconds.</p>
</li>
<li>
<p>If we press <code>CTRL-C</code> within these 10 seconds, <code>CancelledError</code> is thrown:</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">A signal handler that cancels all currently running tasks.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> signal
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncio <span style="color:#f92672">import</span> AbstractEventLoop
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Set
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util.delay <span style="color:#f92672">import</span> delay
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cancel_tasks</span>():
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#39;Got a SIGINT&#39;</span>)
</span></span><span style="display:flex;"><span>  tasks : Set[asyncio<span style="color:#f92672">.</span>Task] <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>all_tasks()
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Cancelling </span><span style="color:#e6db74">{</span>len(tasks)<span style="color:#e6db74">}</span><span style="color:#e6db74"> task(s).&#39;</span>)
</span></span><span style="display:flex;"><span>  [task<span style="color:#f92672">.</span>cancel() <span style="color:#66d9ef">for</span> task <span style="color:#f92672">in</span> tasks]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  loop : AbstractEventLoop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_running_loop()
</span></span><span style="display:flex;"><span>  loop<span style="color:#f92672">.</span>add_signal_handler(signal<span style="color:#f92672">.</span>SIGINT, cancel_tasks)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> delay(<span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> selectors
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> selectors <span style="color:#f92672">import</span> SelectorKey
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> List, Tuple
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>selector <span style="color:#f92672">=</span> selectors<span style="color:#f92672">.</span>DefaultSelector()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create a TCP socket server</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM) # socket.AF_INET := type of address, here the hostname and port number # socket.SOCK_STREAM := TCP protocol will be used</span>
</span></span><span style="display:flex;"><span>server_socket <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket()
</span></span><span style="display:flex;"><span>server_socket<span style="color:#f92672">.</span>setsockopt(socket<span style="color:#f92672">.</span>SOL_SOCKET, socket<span style="color:#f92672">.</span>SO_REUSEADDR, <span style="color:#ae81ff">1</span>) <span style="color:#75715e"># socket.SO_REUSEADDR, 1 := reuse the port number after stopping and restarting the application</span>
</span></span><span style="display:flex;"><span>server_socket<span style="color:#f92672">.</span>setblocking(<span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>server_address <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;127.0.0.1&#39;</span>, <span style="color:#ae81ff">8000</span>) 
</span></span><span style="display:flex;"><span>server_socket<span style="color:#f92672">.</span>bind(server_address) <span style="color:#75715e"># clients will use 127.0.0.1 to send data to our server</span>
</span></span><span style="display:flex;"><span>server_socket<span style="color:#f92672">.</span>listen() <span style="color:#75715e"># allows clients to connect to our server socket</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>selector<span style="color:#f92672">.</span>register(server_socket, selectors<span style="color:#f92672">.</span>EVENT_READ)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>  events: List[Tuple[SelectorKey, int]] <span style="color:#f92672">=</span> selector<span style="color:#f92672">.</span>select(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>) <span style="color:#75715e"># create a selector that will timeout after 1 sec</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> len(events) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;No events, waiting a bit more!&#39;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> event, _ <span style="color:#f92672">in</span> events:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    event_socket <span style="color:#f92672">=</span> event<span style="color:#f92672">.</span>fileobj <span style="color:#75715e"># gets the socket for the event, which is stored in the fileobj field</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> event_socket <span style="color:#f92672">==</span> server_socket: <span style="color:#75715e"># This is a connection attempt.</span>
</span></span><span style="display:flex;"><span>      connection, client_address <span style="color:#f92672">=</span> server_socket<span style="color:#f92672">.</span>accept() <span style="color:#75715e"># wait for a connection by blocking until we get a communication # connection:= another socket that we read data from and write data to our client # client_address:= the address of the client that connected</span>
</span></span><span style="display:flex;"><span>      connection<span style="color:#f92672">.</span>setblocking(<span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>      print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;I got a connection from </span><span style="color:#e6db74">{</span>client_address<span style="color:#e6db74">}</span><span style="color:#e6db74">!&#39;</span>)
</span></span><span style="display:flex;"><span>      selector<span style="color:#f92672">.</span>register(connection, selectors<span style="color:#f92672">.</span>EVENT_READ) <span style="color:#75715e"># register the client that connected with our selector</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>      data <span style="color:#f92672">=</span> event_socket<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>) <span style="color:#75715e"># receive data from the client, and echo it back</span>
</span></span><span style="display:flex;"><span>      print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;I got some data: </span><span style="color:#e6db74">{</span>data<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>      event_socket<span style="color:#f92672">.</span>send(data)
</span></span></code></pre></div><hr>
<h2 id="concurrency-methods">Concurrency methods</h2>
<h3 id="multiple-processing">Multiple processing</h3>
<ul>
<li>
<p>It runs simultaneous things at the same time.</p>
</li>
<li>
<p>Each process runs on a different core.</p>
</li>
<li>
<p>It is best when we have CPU-intensive work.</p>
</li>
<li>
<p><code>if __name__ == &quot;__main__&quot;</code> will be used. Otherwise, <code>multiprocessing</code> module will complain.</p>
</li>
<li>
<p><code>multiprocessing</code> steps:</p>
<ol>
<li>It creates a process with <code>target</code> function, where <code>Process()</code> specifies the target function that the process runs.</li>
<li>It calls its <code>start</code> method to execute it.</li>
<li>It calls its <code>join</code> method to make other processes wait for it to complete running.</li>
</ol>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> multiprocess <span style="color:#f92672">import</span> Process
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello_from_process</span>():
</span></span><span style="display:flex;"><span> print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Hello from child process </span><span style="color:#e6db74">{</span>os<span style="color:#f92672">.</span>getpid()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># `Process(target=&lt;function&gt;, args=&lt;parameters_of_the_function&gt;`</span>
</span></span><span style="display:flex;"><span> hello_process <span style="color:#f92672">=</span> Process(target<span style="color:#f92672">=</span>hello_from_process)
</span></span><span style="display:flex;"><span> hello_process<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span> print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Hello from process </span><span style="color:#e6db74">{</span>os<span style="color:#f92672">.</span>getpid()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span> hello_process<span style="color:#f92672">.</span>join() <span style="color:#75715e"># `join` blocks the main process until each process has finished</span>
</span></span></code></pre></div><h3 id="single-processing">Single processing</h3>
<h4 id="asynchronous-io-asyncio">Asynchronous I/O: <code>asyncio</code></h4>
<ul>
<li>
<p>It uses <code>cooperative multitasking</code>, and runs one at a time. It cooperates by announcing when they&rsquo;re ready to be switched out.</p>
</li>
<li>
<p>It leads to resource utilization improvements for applications that use I/O operations.</p>
<ul>
<li>It handles multiple I/O operations at once.</li>
</ul>
</li>
<li>
<p>It allows us to pause the execution of a particular method when we have an I/O operation; we can run other code while waiting for our initial I/O to complete in the background.</p>
</li>
<li>
<p>It may interoperate with <code>multithreading</code> and <code>multiprocessing</code>.</p>
</li>
<li>
<p>In asyncio, the event loop keeps a queue of tasks instead of messages.</p>
</li>
<li>
<p>It primarily helps us make I/O-bound work concurrent, but it exposes APIs for making CPU-bound work concurrent as well.</p>
</li>
<li>
<p>The steps to write an asyncio program are as follows:</p>
<ol>
<li>Create an event loop.</li>
<li>Call async/await functions which are coroutines.</li>
<li>Create a task to run on the loop.</li>
<li>Wait for the tasks to be complete.</li>
<li>Close the loop.</li>
</ol>
</li>
</ul>
<h4 id="multithreading">Multithreading</h4>
<ul>
<li>Independent code pieces can be put in multiple threads that the CPU can, in theory, run concurrently on multiple cores.</li>
<li>User-created threads in Python do not receive <code>KeyboardInterrupt</code> exceptions; only the main thread will receive them. To handle this:
<ol>
<li><strong><em>Daemon threads (demon)</em> for long-running background tasks</strong> To terminate our app properly, we set <code>thread.daemon=True</code> before we run <code>thread.start()</code>.</li>
<li><strong>Cancelling or interrupting a running thread in our way</strong></li>
</ol>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os<span style="color:#f92672">,</span> threading
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello_from_thread</span>():
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Hello from thread </span><span style="color:#e6db74">{</span>threading<span style="color:#f92672">.</span>current_thread()<span style="color:#e6db74">}</span><span style="color:#e6db74">!&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>hello_thread <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>hello_from_thread)
</span></span><span style="display:flex;"><span>hello_thread<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Python process running with process id: </span><span style="color:#e6db74">{</span>os<span style="color:#f92672">.</span>getpid()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>total_threads <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>active_count()
</span></span><span style="display:flex;"><span>thread_name <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>current_thread()<span style="color:#f92672">.</span>name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Python is currently running </span><span style="color:#e6db74">{</span>total_threads<span style="color:#e6db74">}</span><span style="color:#e6db74"> thread(s).&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;The current thread is </span><span style="color:#e6db74">{</span>thread_name<span style="color:#e6db74">}</span><span style="color:#e6db74">.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># join will cause the program to pause until the thread we started is completed.</span>
</span></span><span style="display:flex;"><span>hello_thread<span style="color:#f92672">.</span>join()
</span></span></code></pre></div><h4 id="threading"><code>threading</code></h4>
<ul>
<li>It runs one at a time.</li>
<li>It allows you to have different parts of your program run concurrently.</li>
<li>It can simplify your design.</li>
<li>It uses <code>preemptive multitasking</code>.</li>
<li>If the task is I/O bound, you can use it.</li>
</ul>
<p><strong>Tip:</strong> When you’re determining the number of threads to use for a particular problem, it is best to start small (the amount of CPU cores plus a few is a good starting point), test it, and benchmark it, gradually increasing the number of threads.</p>
<hr>
<h2 id="concurrent-futures">concurrent futures</h2>
<h3 id="concurrentfutures-module"><code>concurrent.futures</code> module</h3>
<ul>
<li>Future is thread-safe.</li>
<li>If I have a small number of tasks, I schedule them all in one go and wait for them all to be complete. Here&rsquo;s a simple example:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> concurrent.futures
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Executor manages all the tasks that are running, either in separate processes or threads.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> concurrent<span style="color:#f92672">.</span>futures<span style="color:#f92672">.</span>Executor() <span style="color:#66d9ef">as</span> executor:
</span></span><span style="display:flex;"><span>    futures <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        executor<span style="color:#f92672">.</span>submit(perform, task) <span style="color:#66d9ef">for</span> task <span style="color:#f92672">in</span> get_tasks_to_do()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> future <span style="color:#f92672">in</span> concurrent<span style="color:#f92672">.</span>futures<span style="color:#f92672">.</span>as_completed(futures):
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;The outcome is </span><span style="color:#e6db74">{</span>future<span style="color:#f92672">.</span>result()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><h3 id="executor">executor</h3>
<h4 id="executor-objects">Executor Objects</h4>
<ul>
<li>It provides methods to execute calls asynchronously.</li>
</ul>
<h5 id="1-threadpoolexecutor">1. ThreadPoolExecutor</h5>
<ul>
<li>Asynchronous execution can be performed with threads.</li>
</ul>
<h5 id="2-processpoolexecutor">2. ProcessPoolExecutor</h5>
<ul>
<li>Separate processes</li>
</ul>
<hr>
<h2 id="handling-cpu-bound-work">Handling CPU-bound work</h2>
<h3 id="using-process-pools">Using process pools</h3>
<ul>
<li><code>multiprocessing</code> module has <code>process pools</code>, which is similar to <code>connection pools</code>.
<ul>
<li><code>process pools</code> creates a collection of Python processes.</li>
</ul>
</li>
<li>By default, it will create processes equal to the number of cores, <code>multiprocessing.cpu_count()</code>.</li>
</ul>
<h3 id="using-async-and-await-to-manage-cpu-bound-work">Using <code>async</code> and <code>await</code> to manage CPU-bound work</h3>
<ul>
<li>
<p><code>with Pool() as process_pool:</code> to avoid resource-utilization issues.</p>
</li>
<li>
<p><strong>Problem:</strong> <code>process_pool.apply()</code> blocks until the function completes.</p>
</li>
<li>
<p><strong>Solution:</strong> Use <code>apply_async</code> and <code>get</code> method to block and obtain the results of the function call.</p>
</li>
</ul>
<h4 id="executor-an-abstract-class-of-concurrentfutures-module"><code>Executor</code> (an abstract class of <code>concurrent.futures</code> module)</h4>
<h5 id="methods-for-asynchronously-running-works">Methods for asynchronously running works</h5>
<ol>
<li><code>submit(&lt;callable&gt;) -&gt; &lt;Future&gt;</code> is equivalent to <code>Pool.apply_sync</code>.</li>
<li><code>map(&lt;callable&gt;, [&lt;function arguments&gt;]) -&gt; &lt;Iterator_of_results&gt;</code> executes each argument asynchronously. It returns similarly to <code>asyncio.as_completed</code>.</li>
</ol>
<h5 id="processpoolexecutor-implementation-of-poolexecutor"><code>ProcessPoolExecutor</code> implementation of <code>PoolExecutor</code></h5>
<ul>
<li>The order of iteration is deterministic based on the order we passed in the list, which differs from <code>asyncio.as_completed</code>.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ProcessPoolExecutor
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> partial
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> List
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">count</span>(count_to: int) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>  counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> counter <span style="color:#f92672">&lt;</span> count_to:
</span></span><span style="display:flex;"><span>    counter <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> counter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">with</span> ProcessPoolExecutor <span style="color:#66d9ef">as</span> process_pool:
</span></span><span style="display:flex;"><span>    loop: AbstractEventLoop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_running_loop()
</span></span><span style="display:flex;"><span>    numbers <span style="color:#f92672">=</span> [ <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">22</span>, <span style="color:#ae81ff">100000000</span>]
</span></span><span style="display:flex;"><span>    calls: List[partial[int]] <span style="color:#f92672">=</span> [ partial(count, num) <span style="color:#66d9ef">for</span> num <span style="color:#f92672">in</span> nums ]
</span></span><span style="display:flex;"><span>    call_coros <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> call <span style="color:#f92672">in</span> calls:
</span></span><span style="display:flex;"><span>      call_coros<span style="color:#f92672">.</span>append(loop<span style="color:#f92672">.</span>run_in_executor(process_pool, call))
</span></span><span style="display:flex;"><span>    results <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>gather(<span style="color:#f92672">*</span>call_coros)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> result <span style="color:#f92672">in</span> results:
</span></span><span style="display:flex;"><span>      print(result)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>  asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><ul>
<li><code>run_in_executor</code> (asyncio event loop) takes in a callable alongside an executor (either a thread pool or process pool) and runs that callable inside the pool. It returns an awaitable, which can be used in an <code>await</code> statement or passed into an API function such as <code>gather</code>.</li>
</ul>
<h3 id="solving-a-problem-with-mapreduce-using-asyncio">Solving a problem with MapReduce using <code>asyncio</code></h3>
<ul>
<li>Implementing a MapReduce workflow with multiprocessing is the in mapreduce folder.</li>
</ul>
<h3 id="handling-shared-data-between-multiple-processes-with-locks">Handling shared data between multiple processes with locks</h3>
<ul>
<li>Multiprocessing supports the <code>shared memory objects</code> concept.
<ul>
<li><code>Shared memory object</code> is a chunk of memory allocated that a set of the separate process can access. Each process can read and write into that memory space as needed.</li>
</ul>
</li>
<li>Multiprocessing supports two kinds of shared data:
<ul>
<li>values</li>
<li>array</li>
</ul>
</li>
<li>A <code>lock</code>, or <code>mutual exclusion</code> (<code>mutex</code>), synchronizes the access to shared data.</li>
<li><code>Critical section</code> is the locked section of a code.</li>
<li>Locks support two main operations:
<ul>
<li>acquire the lock <code>get_lock.acquire()</code></li>
<li>release the lock <code>get_lock.release()</code></li>
</ul>
</li>
</ul>
<h4 id="sharing-data-with-process-pools">Sharing data with process pools</h4>
<ul>
<li>Neither <code>Value</code> nor <code>Array</code> objects cannot be pickled and unpickled.</li>
<li><code>process pool initializers</code> are called when each process in our pool starts up. Using this, we can create a reference to the shared memory that our parent process created.</li>
</ul>
<hr>
<h2 id="handling-blocking-work-with-threads">Handling blocking work with threads</h2>
<h3 id="1-threading-module">1. <code>threading</code> module</h3>
<ul>
<li>It creates and manages threads.</li>
<li>It exposes <code>Thread</code> class.
<ul>
<li><code>Thread</code> has a <code>run</code> method that we can override.</li>
</ul>
</li>
<li><code>cancel</code> method definition by subclassing the <code>Thread</code> class lets to shut down the client socket. Then, <code>recv</code> and <code>sendall</code> will be interrupted, allowing to exit <code>while</code> loop and close out the thread.</li>
<li>How to cleanly terminate threads on application shutdown. (<a href="multithreaded_echo_server.py" >code</a>
)</li>
</ul>
<h3 id="2-using-threads-with-asyncio">2. Using threads with <code>asyncio</code></h3>
<ul>
<li>Use threads with asyncio to run web requests concurrently</li>
</ul>
<h4 id="21-requests-a-popular-http-client-library">2.1. <code>requests</code>: A popular HTTP client library</h4>
<ul>
<li>It is blocking so each call to <code>requests.get</code> will stop any thread from executing other Python code until the request finishes.</li>
<li>Using it in a coroutine or a task by itself, will block the entire event loop until the request finishes.</li>
<li>To properly use this library with asyncio, we must run these blocking operations inside of a thread.</li>
</ul>
<h4 id="22-thread-pool-executors">2.2. Thread pool executors</h4>
<ul>
<li>Use this to distribute work to a pool of threads.</li>
<li><code>Executor</code> abstract class provides an implementation to work with threads named <code>ThreadPoolExecutor</code>.</li>
</ul>
<h4 id="23-thread-pool-executors-with-asyncio">2.3. Thread pool executors with <code>asyncio</code></h4>
<ul>
<li>A pool of threads allows us to use asyncio API methods like gather to wait for results from threads.</li>
</ul>
<h4 id="24-default-executors">2.4. Default executors</h4>
<ul>
<li><code>asyncio.to_thread</code> coroutine was introduced to further simplify putting work on the default thread pool executor. It takes in a function to run in a thread and a set of arguments to pass to that function. (<a href="to_thread.py" >code</a>
)</li>
</ul>
<h3 id="3-locks-shared-data-and-deadlocks">3. Locks, shared data, and deadlocks</h3>
<ul>
<li>Any time you have two threads or processes that could modify a shared piece of non-thread-safe data, you’ll need to utilize a lock to properly synchronize access.</li>
<li>Avoid race conditions with locks from the <code>threading</code> module, <code>Lock</code> implementation.
<ul>
<li>Call its <code>acquire</code> and <code>release</code> methods around critical sections of code or use it in <code>context manager</code>.</li>
</ul>
</li>
<li><code>from threading import Lock</code></li>
<li><code>list_lock = Lock()</code></li>
</ul>
<h4 id="31-reentrant-locks">3.1. Reentrant locks</h4>
<ul>
<li>Avoid deadlocks with reentrant locks</li>
<li>A reentrant lock is a special kind of lock that can be acquired by the same thread more than once, allowing the thread to reenter the critical sections</li>
<li><code>from threading import Rlock</code></li>
<li><code>list_lock = RLock()</code></li>
<li>Internally, reentrant locks work by keeping a recursion count. Each time we acquire the lock from the thread that first acquired the lock, the count increases, and each time we release the lock it decreases. When the count is 0, the lock is finally released for other threads to acquire it.</li>
</ul>
<h4 id="32-deadlocks">3.2. Deadlocks</h4>
<ul>
<li>It is impossible to have a deadlock with one lock, excluding the reentrant deadlock.</li>
<li>Overall, when dealing with multiple locks that you need to acquire, ask yourself:
<ul>
<li>Am I acquiring these locks in a consistent order?</li>
<li>Is there a way I can refactor this to use only one lock?</li>
</ul>
</li>
</ul>
<h3 id="4-event-loops-in-separate-threads">4. Event loops in separate threads</h3>
<ul>
<li>Run the asyncio event loop in a separate thread and send coroutines to it in a thread-safe manner</li>
<li>Use multithreading to run multiple event loops at the same time by building a responsive HTTP stress-testing user interface in Tkinter.</li>
</ul>
<h4 id="41-tkinter">4.1. <code>Tkinter</code></h4>
<ul>
<li>A platform-independent desktop GUI toolkit provided in the default Python installation.</li>
<li>Responsive user interfaces with frameworks</li>
<li><code>Tkinter</code> is not asyncio-aware.</li>
</ul>
<h4 id="42-building-a-responsive-ui-with-asyncio-and-threads">4.2. Building a responsive UI with <code>asyncio</code> and threads</h4>
<ul>
<li>There are a few <code>asyncio</code> functions to learn that both are non-blocking and have thread safety built in to submit this kind of work properly.
<ol>
<li>An asyncio event loop <code>call_soon_threadsafe</code> function takes in a Python function (not a coroutine) and schedules it to execute it in a thread-safe manner at the next iteration of the asyncio event loop.</li>
<li><code>asyncio.run_coroutine_threadsafe</code></li>
</ol>
</li>
</ul>
<p>@todo 180-184 skipped</p>
<h3 id="5-using-threads-for-cpu-bound-work">5. Using threads for CPU-bound work</h3>
<ul>
<li><code>hashlib</code> and <code>numpy</code> perform CPU-intensive work in pure C and release GIL.</li>
</ul>
<h4 id="51-multithreading-with-hashlib">5.1. Multithreading with <code>hashlib</code></h4>
<ul>
<li>Hashing sensitive text for security (<a href="multithread_hashing.py" >code</a>
)</li>
</ul>
<h4 id="52-multithreading-with-numpy">5.2. Multithreading with <code>numpy</code></h4>
<ul>
<li>Solving a data analysis problem (<a href="multithread_numpy.py" >code</a>
)</li>
<li>It is generally safe to assume matrix operations can potentially be multithreaded for a performance win.</li>
</ul>
<hr>
<h2 id="multithread-hashing">Multithread hashing</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> functools
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> hashlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> concurrent.futures.thread <span style="color:#f92672">import</span> ThreadPoolExecutor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">random_password</span>(length: int) <span style="color:#f92672">-&gt;</span> bytes:
</span></span><span style="display:flex;"><span>  ascii_lowercase <span style="color:#f92672">=</span> string<span style="color:#f92672">.</span>ascii_lowercase<span style="color:#f92672">.</span>encode()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(bytes(random<span style="color:#f92672">.</span>choice(ascii_lowercase)) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(length))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>passwords <span style="color:#f92672">=</span> [ random_password(<span style="color:#ae81ff">10</span>) <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10000</span>) ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hash</span>(password: bytes) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>  salt <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>urandom(<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> str(hashlib<span style="color:#f92672">.</span>scrypt(password, salt<span style="color:#f92672">=</span>salt, n<span style="color:#f92672">=</span><span style="color:#ae81ff">2048</span>, p<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, r<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  loop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_running_loop()
</span></span><span style="display:flex;"><span>  tasks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">with</span> ThreadPoolExecutor() <span style="color:#66d9ef">as</span> pool:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> password <span style="color:#f92672">in</span> passwords:
</span></span><span style="display:flex;"><span>      tasks<span style="color:#f92672">.</span>append(loop<span style="color:#f92672">.</span>run_in_executor(pool, functools<span style="color:#f92672">.</span>partial(hash, password)))
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>gather(<span style="color:#f92672">*</span>tasks)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><hr>
<h2 id="multithread-numpy">Multithread numpy</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> functools
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> concurrent.futures.thread <span style="color:#f92672">import</span> ThreadPoolExecutor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data_points <span style="color:#f92672">=</span> <span style="color:#ae81ff">4000000000</span>
</span></span><span style="display:flex;"><span>rows <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>columns <span style="color:#f92672">=</span> int(data_points <span style="color:#f92672">/</span> rows)
</span></span><span style="display:flex;"><span>matrix <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(data_points)<span style="color:#f92672">.</span>reshape(rows, columns)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">mean_for_row</span>(arr, row):
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> np<span style="color:#f92672">.</span>mean(arr[row])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  loop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_running_loop()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">with</span> ThreadPoolExecutor() <span style="color:#66d9ef">as</span> pool:
</span></span><span style="display:flex;"><span>    tasks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(rows):
</span></span><span style="display:flex;"><span>      mean <span style="color:#f92672">=</span> functools<span style="color:#f92672">.</span>partial(mean_for_row, matrix, i)
</span></span><span style="display:flex;"><span>      tasks<span style="color:#f92672">.</span>append(loop<span style="color:#f92672">.</span>run_in_executor(pool, mean))
</span></span><span style="display:flex;"><span>    results <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>gather(<span style="color:#f92672">*</span>tasks)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><hr>
<h2 id="multithread-echo-server">Multithread echo server</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> threading <span style="color:#f92672">import</span> Thread
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClientEchoThread</span>(Thread): <span style="color:#75715e"># inherits from `Thread` class</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> __init__(self, client):
</span></span><span style="display:flex;"><span>  super()<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>  self<span style="color:#f92672">.</span>client <span style="color:#f92672">=</span> client
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(self):
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">2048</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> data: <span style="color:#75715e"># when the connection was shut down or closed by the client</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">BrokenPipeError</span>(<span style="color:#e6db74">&#39;Connection closed!&#39;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Received </span><span style="color:#e6db74">{</span>data<span style="color:#e6db74">}</span><span style="color:#e6db74">, sending!&#39;</span>)
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>sendall(data)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">OSError</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>   print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Thread interrupted by </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74"> exception, shutting down!&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">close</span>(self):
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>is_alive(): <span style="color:#75715e"># shut down the connection if the thread is alive; the thread may not be alive if the client closed the connection</span>
</span></span><span style="display:flex;"><span>   self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>sendall(bytes(<span style="color:#e6db74">&#39;Shutting down!&#39;</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>   self<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>shutdown(socket<span style="color:#f92672">.</span>SHUT_RDWR) <span style="color:#75715e"># shut down the client connection for reads and writes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM) <span style="color:#66d9ef">as</span> server:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> server<span style="color:#f92672">.</span>setsockopt(socket<span style="color:#f92672">.</span>SOL_SOCKET, socket<span style="color:#f92672">.</span>SO_REUSEADDR, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span> server<span style="color:#f92672">.</span>bind((<span style="color:#e6db74">&#39;127.0.0.1&#39;</span>, <span style="color:#ae81ff">8000</span>))
</span></span><span style="display:flex;"><span> server<span style="color:#f92672">.</span>listen()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> connection_threads <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>: <span style="color:#75715e"># listen for connections on our server socket</span>
</span></span><span style="display:flex;"><span>   connection, _ <span style="color:#f92672">=</span> server<span style="color:#f92672">.</span>accept() <span style="color:#75715e"># block waiting for a client to connect</span>
</span></span><span style="display:flex;"><span>   thread <span style="color:#f92672">=</span> ClientEchoThread(connection)
</span></span><span style="display:flex;"><span>   connection_threads<span style="color:#f92672">.</span>append(thread) 
</span></span><span style="display:flex;"><span>   thread<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyboardInterrupt</span>:
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#39;Shutting down!&#39;</span>)
</span></span><span style="display:flex;"><span>  [ thread<span style="color:#f92672">.</span>close() <span style="color:#66d9ef">for</span> thread <span style="color:#f92672">in</span> connection_threads ]
</span></span></code></pre></div><hr>
<h2 id="non-blocking-database-drivers">Non-blocking database drivers</h2>
<ul>
<li>We need to use an asyncio-friendly library that uses non-blocking sockets since typical SQL libraries block the main thread (therefore the event loop) until a result is retrieved.</li>
</ul>
<h3 id="running-asyncio-friendly-database-queries-with-asyncpg">Running asyncio-friendly database queries with <code>asyncpg</code></h3>
<ul>
<li><code>asyncpg</code> asynchronously connects Postgres and runs queries against them. (<code>aiomysl</code> := MySQL)</li>
<li>To run queries against our database, we first connect to our Postgres instance and create the database directly outside of Python.</li>
<li><code>execute</code> inserts data, and <code>fetch</code> runs a query.</li>
<li><code>fetch</code> gets all results, whereas <code>fetchrow</code> returns a single query.</li>
</ul>
<h4 id="connecting-to-a-postgres-database-creating-a-database-and-running-queries">Connecting to a Postgres database, creating a database, and running queries</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncpg
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncpg <span style="color:#f92672">import</span> Record
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> List
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CREATE_BRAND_TABLE <span style="color:#f92672">=</span> \
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  CREATE TABLE IF NOT EXISTS brand(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    brand_id SERIAL PRIMARY KEY,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    brand_name TEXT NOT NULL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  );&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CREATE_PRODUCT_TABLE <span style="color:#f92672">=</span> \
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  CREATE TABLE IF NOT EXISTS product(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    product_id SERIAL PRIMARY KEY,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    product_name TEXT NOT NULL,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    brand_id INT NOT NULL,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    FOREIGN KEY (brand_id) REFERENCES brand(brand_id)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  );&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CREATE_PRODUCT_COLOR_TABLE <span style="color:#f92672">=</span> \
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  CREATE TABLE IF NOT EXISTS product_color(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    product_color_id SERIAL PRIMARY KEY,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    product_color_name TEXT NOT NULL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  );&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CREATE_PRODUCT_SIZE_TABLE <span style="color:#f92672">=</span> \
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  CREATE TABLE IF NOT EXISTS product_size(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    product_size_id SERIAL PRIMARY KEY,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    product_size_name TEXT NOT NULL
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  );&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CREATE_SKU_TABLE <span style="color:#f92672">=</span> \
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  CREATE TABLE IF NOT EXISTS sku(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    sku_id SERIAL PRIMARY KEY,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    product_id INT NOT NULL,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    product_size_id INT NOT NULL,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    product_color_id INT NOT NULL,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    FOREIGN KEY (product_id) REFERENCES product(product_id),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    FOREIGN KEY (product_size_id) REFERENCES product_size(product_size_id),
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    FOREIGN KEY (product_color_id) REFERENCES product_color(product_color_id)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  );&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COLOR_INSERT <span style="color:#f92672">=</span> \
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  INSERT INTO product_color VALUES(1, &#39;Blue&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  INSERT INTO product_color VALUES(2, &#39;Black&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>SIZE_INSERT <span style="color:#f92672">=</span> \
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  INSERT INTO product_size VALUES(1, &#39;Small&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  INSERT INTO product_size VALUES(2, &#39;Medium&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  INSERT INTO product_size VALUES(3, &#39;Large&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  connection <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncpg<span style="color:#f92672">.</span>connect( host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>                                      port<span style="color:#f92672">=</span><span style="color:#ae81ff">5432</span>,
</span></span><span style="display:flex;"><span>                                      user<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;postgres&#39;</span>,
</span></span><span style="display:flex;"><span>                                      database<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;products&#39;</span>,
</span></span><span style="display:flex;"><span>                                      password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span> )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  statements <span style="color:#f92672">=</span> [  CREATE_BRAND_TABLE,
</span></span><span style="display:flex;"><span>                  CREATE_PRODUCT_TABLE,
</span></span><span style="display:flex;"><span>                  CREATE_PRODUCT_COLOR_TABLE,
</span></span><span style="display:flex;"><span>                  CREATE_PRODUCT_SIZE_TABLE,
</span></span><span style="display:flex;"><span>                  CREATE_SKU_TABLE,
</span></span><span style="display:flex;"><span>                  SIZE_INSERT,
</span></span><span style="display:flex;"><span>                  COLOR_INSERT ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#39;Creating the product database...&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> statement <span style="color:#f92672">in</span> statements:
</span></span><span style="display:flex;"><span>    status <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>execute(statement)
</span></span><span style="display:flex;"><span>    print(status)
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#39;Finished creating the product database!&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;INSERT INTO brand VALUES(DEFAULT, &#39;Levis&#39;)&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;INSERT INTO brand VALUES(DEFAULT, &#39;Seven&#39;)&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  results : List[Record] <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>fetch(<span style="color:#e6db74">&#39;SELECT brand_id, brand_name FROM brand&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> brand <span style="color:#f92672">in</span> results:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;id: </span><span style="color:#e6db74">{</span>brand[<span style="color:#e6db74">&#34;brand_id&#34;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">, name: </span><span style="color:#e6db74">{</span>brand[<span style="color:#e6db74">&#34;brand_name&#34;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h3 id="executing-queries-concurrently-with-connection-pools">Executing queries concurrently with connection pools</h3>
<ul>
<li><code>executemany</code> coroutine writes an SQL query and passes in a list of parameters we want to insert instead of having to create one <code>INSERT</code> statement for each brand.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncpg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Tuple, Union, List
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> random <span style="color:#f92672">import</span> sample
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_common_words</span>() <span style="color:#f92672">-&gt;</span> List[str]:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;/Users/macos/Desktop/python/concurrency/common_words.txt&#39;</span>) <span style="color:#66d9ef">as</span> common_words:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> common_words<span style="color:#f92672">.</span>readlines()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_brand_names</span>(words: List[str]) <span style="color:#f92672">-&gt;</span> List[Tuple[Union[str, ]]]:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> [(words[index],) <span style="color:#66d9ef">for</span> index <span style="color:#f92672">in</span> sample(range(<span style="color:#ae81ff">100</span>), <span style="color:#ae81ff">100</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">insert_brands</span>(common_words, connection) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>  brands <span style="color:#f92672">=</span> generate_brand_names(common_words)
</span></span><span style="display:flex;"><span>  insert_brands <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;INSERT INTO brand VALUES(DEFAULT, $1)&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>executemany(insert_brands, brands)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  common_words <span style="color:#f92672">=</span> load_common_words()
</span></span><span style="display:flex;"><span>  connection <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncpg<span style="color:#f92672">.</span>connect( host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>                                      port<span style="color:#f92672">=</span><span style="color:#ae81ff">5432</span>,
</span></span><span style="display:flex;"><span>                                      user<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;postgres&#39;</span>,
</span></span><span style="display:flex;"><span>                                      database<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;products&#39;</span>,
</span></span><span style="display:flex;"><span>                                      password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span> )
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> insert_brands(common_words, connection)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncpg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> List, Tuple
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> random <span style="color:#f92672">import</span> sample, randint
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_common_words</span>() <span style="color:#f92672">-&gt;</span> List[str]:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;/Users/macos/Desktop/python/concurrency/common_words.txt&#39;</span>) <span style="color:#66d9ef">as</span> file:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> file<span style="color:#f92672">.</span>readlines()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gen_products</span>( common_words: List[str],
</span></span><span style="display:flex;"><span>                  brand_id_start: int,
</span></span><span style="display:flex;"><span>                  brand_id_end: int,
</span></span><span style="display:flex;"><span>                  products_to_create: int ) <span style="color:#f92672">-&gt;</span> List[ Tuple[str, int] ]:
</span></span><span style="display:flex;"><span>  products <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(products_to_create):
</span></span><span style="display:flex;"><span>    description <span style="color:#f92672">=</span> [ common_words[index] <span style="color:#66d9ef">for</span> index <span style="color:#f92672">in</span> sample(range(<span style="color:#ae81ff">1000</span>), <span style="color:#ae81ff">10</span>) ]
</span></span><span style="display:flex;"><span>    brand_id <span style="color:#f92672">=</span> randint(brand_id_start, brand_id_end)
</span></span><span style="display:flex;"><span>    products<span style="color:#f92672">.</span>append((<span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">.</span>join(description), brand_id))
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> products
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gen_skus</span>( product_id_start: int,
</span></span><span style="display:flex;"><span>              product_id_end: int,
</span></span><span style="display:flex;"><span>              skus_to_create: int ) <span style="color:#f92672">-&gt;</span> List[Tuple[int, int, int]]:
</span></span><span style="display:flex;"><span>  skus <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(skus_to_create):
</span></span><span style="display:flex;"><span>    product_id <span style="color:#f92672">=</span> randint(product_id_start, product_id_end)
</span></span><span style="display:flex;"><span>    size_id <span style="color:#f92672">=</span> randint(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>    color_id <span style="color:#f92672">=</span> randint(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    skus<span style="color:#f92672">.</span>append((product_id, size_id, color_id))
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> skus
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  common_words <span style="color:#f92672">=</span> load_common_words()
</span></span><span style="display:flex;"><span>  connection <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncpg<span style="color:#f92672">.</span>connect( host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>                                      port<span style="color:#f92672">=</span><span style="color:#ae81ff">5432</span>,
</span></span><span style="display:flex;"><span>                                      user<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;postgres&#39;</span>,
</span></span><span style="display:flex;"><span>                                      database<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;products&#39;</span>,
</span></span><span style="display:flex;"><span>                                      password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span> )
</span></span><span style="display:flex;"><span>  product_tuples <span style="color:#f92672">=</span> gen_products( common_words,
</span></span><span style="display:flex;"><span>                                  brand_id_start<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>                                  brand_id_end<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>,
</span></span><span style="display:flex;"><span>                                  products_to_create<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span> )
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>executemany(<span style="color:#e6db74">&#34;INSERT INTO product VALUES(DEFAULT, $1, $2)&#34;</span>, product_tuples)
</span></span><span style="display:flex;"><span>  sku_tuples <span style="color:#f92672">=</span> gen_skus( product_id_start<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>                         product_id_end<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>,
</span></span><span style="display:flex;"><span>                         skus_to_create<span style="color:#f92672">=</span><span style="color:#ae81ff">100000</span> )
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>executemany(<span style="color:#e6db74">&#34;INSERT INTO sku VALUES(DEFAULT, $1, $2, $3)&#34;</span>, sku_tuples)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h4 id="creating-database-connection-pools-running-multiple-sql-queries-concurrently">Creating database connection pools running multiple SQL queries concurrently</h4>
<ul>
<li>A connection pool contains a finite number of connections that we can access when we need to run a query.</li>
<li>Once a connection is acquired from the pool (<code>acquire</code>) to run a query and that query finishes, we return or release it to the pool for others to use.</li>
<li><code>asyncpg</code> creates a connection pool using <code>create_pool</code> coroutine, which we use instead of <code>connect</code>.
<ul>
<li>Parameters for a number of connections are <code>min_size</code> and <code>max_size</code>.</li>
</ul>
</li>
<li>async pools use <code>async with</code> syntax, asynchronous context manager.</li>
<li><code>async with connection.transaction()</code> starts a transaction.
<ul>
<li>If there is an exception, the transaction will be rolled back.</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncpg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>product_query <span style="color:#f92672">=</span> \
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SELECT p.product_id, p.product_name, p.brand_id, s.sku_id, pc.product_color_name, ps.product_size_name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">FROM product as p
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">JOIN sku as s on s.product_id = p.product_id
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">JOIN product_color as pc on pc.product_color_id = s.product_color_id
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">JOIN product_size as ps on ps.product_size_id = s.product_size_id
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WHERE p.product_id = 100
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">query_product</span>(pool):
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> pool<span style="color:#f92672">.</span>acquire() <span style="color:#66d9ef">as</span> connection:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>fetchrow(product_query)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> asyncpg<span style="color:#f92672">.</span>create_pool( host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>                                  port<span style="color:#f92672">=</span><span style="color:#ae81ff">5432</span>,
</span></span><span style="display:flex;"><span>                                  user<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;postgres&#39;</span>,
</span></span><span style="display:flex;"><span>                                  password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span>,
</span></span><span style="display:flex;"><span>                                  database<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;products&#39;</span>,
</span></span><span style="display:flex;"><span>                                  min_size<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>,
</span></span><span style="display:flex;"><span>                                  max_size<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> ) <span style="color:#66d9ef">as</span> pool:
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># execute two product queries concurrently</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>gather(query_product(pool), query_product(pool))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h3 id="managing-asynchronous-database-transactions-and-handling-an-error-in-a-transaction">Managing asynchronous database transactions and handling an error in a transaction</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncpg
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  connection <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncpg<span style="color:#f92672">.</span>connect( host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>                                      database<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;products&#39;</span>,
</span></span><span style="display:flex;"><span>                                      username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;postgres&#39;</span>,
</span></span><span style="display:flex;"><span>                                      password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span>,
</span></span><span style="display:flex;"><span>                                      port<span style="color:#f92672">=</span><span style="color:#ae81ff">5432</span> )
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> connection<span style="color:#f92672">.</span>transaction():
</span></span><span style="display:flex;"><span>      insert_brand <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;INSERT INTO brand VALUES(9999, &#39;big_brand&#39;)&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>execute(insert_brand)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>execute(insert_brand) <span style="color:#75715e"># an exception will be raise due to duplicate primary key</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
</span></span><span style="display:flex;"><span>    logging<span style="color:#f92672">.</span>exception(<span style="color:#e6db74">&#39;Error while running transaction&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">finally</span>:
</span></span><span style="display:flex;"><span>    query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT brand_name FROM brand WHERE brand_name LIKE &#39;big_%&#39;&#34;</span>
</span></span><span style="display:flex;"><span>    brands <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>fetch(query)
</span></span><span style="display:flex;"><span>    print(brands) <span style="color:#75715e"># [] := transaction is rolled back.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncpg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncpg.transaction <span style="color:#f92672">import</span> Transaction
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  connection <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncpg<span style="color:#f92672">.</span>connect( host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>                                      database<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;products&#39;</span>,
</span></span><span style="display:flex;"><span>                                      username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;postgres&#39;</span>,
</span></span><span style="display:flex;"><span>                                      password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span>,
</span></span><span style="display:flex;"><span>                                      port<span style="color:#f92672">=</span><span style="color:#ae81ff">5432</span> )
</span></span><span style="display:flex;"><span>  transaction : Transaction <span style="color:#f92672">=</span> connection<span style="color:#f92672">.</span>transaction() <span style="color:#75715e"># creates a transaction instance</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> transaction<span style="color:#f92672">.</span>start() <span style="color:#75715e"># start the transaction</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;INSERT INTO brand VALUES(DEFAULT, &#39;brand_1&#39;)&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;INSERT INTO brand VALUES(DEFAULT, &#39;brand_2&#39;)&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">except</span> asyncpg<span style="color:#f92672">.</span>PostgresError:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;Errors, rolling back transaction!&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> transaction<span style="color:#f92672">.</span>rollback()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;No errors, committing transaction!&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> transaction<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT brand_name FROM brand WHERE brand_name LIKE &#39;big_%&#39;&#34;</span>
</span></span><span style="display:flex;"><span>  brands <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>fetch(query)
</span></span><span style="display:flex;"><span>  print(brands) <span style="color:#75715e"># [] := transaction is rolled back.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h3 id="using-asynchronous-generators-to-stream-query-results">Using asynchronous generators to stream query results</h3>
<ul>
<li>Postgres supports streaming query results through the concept of cursors.
<ul>
<li>Cursors use <code>asynchronous generators</code>.</li>
</ul>
</li>
<li><code>async for</code> fetches elements one at a time from our result set.</li>
<li>Cursors can go forward only. To go backwards, we execute SQL to do so using <code>DECLARE ... SCROLL CURSOR</code>.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncpg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  connection <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncpg<span style="color:#f92672">.</span>connect( host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>                                      database<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;products&#39;</span>,
</span></span><span style="display:flex;"><span>                                      username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;postgres&#39;</span>,
</span></span><span style="display:flex;"><span>                                      password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span>,
</span></span><span style="display:flex;"><span>                                      port<span style="color:#f92672">=</span><span style="color:#ae81ff">5432</span> )
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> connection<span style="color:#f92672">.</span>transaction():
</span></span><span style="display:flex;"><span>    query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;SELECT product_id, product_name FROM product&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## async for ##</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># async for product in connection.cursor(query):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   print(product)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">###############</span>
</span></span><span style="display:flex;"><span>    cursor <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>cursor(query) <span style="color:#75715e"># creates a cursor for the query</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> cursor<span style="color:#f92672">.</span>forward(<span style="color:#ae81ff">500</span>) <span style="color:#75715e"># move the cursor forward 500 records</span>
</span></span><span style="display:flex;"><span>    products <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> cursor<span style="color:#f92672">.</span>fetch(<span style="color:#ae81ff">100</span>) <span style="color:#75715e"># get the next 100 records</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> product <span style="color:#f92672">in</span> products:
</span></span><span style="display:flex;"><span>      print(product)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncpg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">take</span>(generator, to_take: int):
</span></span><span style="display:flex;"><span>  item_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> generator:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> item_count <span style="color:#f92672">&gt;</span> to_take <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    item_count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">yield</span> item
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  connection <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncpg<span style="color:#f92672">.</span>connect( host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>                                      database<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;products&#39;</span>,
</span></span><span style="display:flex;"><span>                                      username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;postgres&#39;</span>,
</span></span><span style="display:flex;"><span>                                      password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span>,
</span></span><span style="display:flex;"><span>                                      port<span style="color:#f92672">=</span><span style="color:#ae81ff">5432</span> )
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> connection<span style="color:#f92672">.</span>transaction():
</span></span><span style="display:flex;"><span>    query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;SELECT product_id, product_name FROM product&#39;</span>
</span></span><span style="display:flex;"><span>    product_generator <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>cursor(query)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">for</span> product <span style="color:#f92672">in</span> take(product_generator, <span style="color:#ae81ff">5</span>):
</span></span><span style="display:flex;"><span>      print(product)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;Got the first 5 products&#39;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> connection<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><p><a href="https://magicstack.github.io/asyncpg/current/" target="_blank" >asyncpg documentation</a>
</p>
<hr>
<h2 id="protocol">Protocol</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncio <span style="color:#f92672">import</span> AbstractEventLoop, Future, Transport
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Optional
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HTTPGetClientProtocol</span>(asyncio<span style="color:#f92672">.</span>Protocol): <span style="color:#75715e"># extends asyncio.Protocol class</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> __init__(self, host: str, loop: AbstractEventLoop):
</span></span><span style="display:flex;"><span>  self<span style="color:#f92672">.</span>_host: str <span style="color:#f92672">=</span> host
</span></span><span style="display:flex;"><span>  self<span style="color:#f92672">.</span>_future: Future <span style="color:#f92672">=</span> loop<span style="color:#f92672">.</span>create_future()
</span></span><span style="display:flex;"><span>  self<span style="color:#f92672">.</span>_transport: Optional[Transport] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span> <span style="color:#75715e"># transport communicates with the server</span>
</span></span><span style="display:flex;"><span>  self<span style="color:#f92672">.</span>_response_buffer: bytes <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_response</span>(self):
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_future
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_get_request_bytes</span>(self) <span style="color:#f92672">-&gt;</span> bytes:
</span></span><span style="display:flex;"><span>  request <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;GET / HTTP/1.1</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span> \
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Connection: close</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span> \
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Host: </span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>_host<span style="color:#e6db74">}</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> request<span style="color:#f92672">.</span>encode()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">connection_made</span>(self, transport: Transport):
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;&#34;&#34; `Transport` calls it when the underlying socket has successfully
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  connected with the HTTP server.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Connection made to </span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>_host<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>  self<span style="color:#f92672">.</span>_transport <span style="color:#f92672">=</span> transport
</span></span><span style="display:flex;"><span>  self<span style="color:#f92672">.</span>_transport<span style="color:#f92672">.</span>write(self<span style="color:#f92672">.</span>_get_request_bytes())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">data_received</span>(self, data):
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;&#34;&#34; `Transport` calls it whenever it receives data,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  passing it to us as bytes.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#39;Data received!&#39;</span>)
</span></span><span style="display:flex;"><span>  self<span style="color:#f92672">.</span>_response_buffer <span style="color:#f92672">+=</span> data <span style="color:#75715e"># _response_buffer can be called multiple times</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">eof_received</span>(self):
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;&#34;&#34;Calling this method guarantees that data_received
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  will never be called again.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  self<span style="color:#f92672">.</span>_future<span style="color:#f92672">.</span>set_result(self<span style="color:#f92672">.</span>_response_buffer<span style="color:#f92672">.</span>decode())
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">connection_lost</span>(self, exc: Optional[<span style="color:#a6e22e">Exception</span>]) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> exc <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>   print(<span style="color:#e6db74">&#39;Connection closed without error.&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>   self<span style="color:#f92672">.</span>_future<span style="color:#f92672">.</span>set_exception(exc)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_request</span>(host: str, port: int, loop: AbstractEventLoop) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">protocol_factory</span>():
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> HTTPGetClientProtocol(host, loop)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> _, protocol <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> loop<span style="color:#f92672">.</span>create_connection(protocol_factory, host<span style="color:#f92672">=</span>host, port<span style="color:#f92672">=</span>port)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> protocol<span style="color:#f92672">.</span>get_response()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span> loop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_running_loop()
</span></span><span style="display:flex;"><span> result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> make_request(<span style="color:#e6db74">&#39;www.example.com&#39;</span>, <span style="color:#ae81ff">80</span>, loop)
</span></span><span style="display:flex;"><span> print(result)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><hr>
<h2 id="server">server</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncio <span style="color:#f92672">import</span> StreamWriter, StreamReader
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ServerState</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>_writers <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_client</span>(self, reader: StreamReader, writer: StreamWriter):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;send messages to all connected clients and
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    remove it when a client disconnects
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>_writers<span style="color:#f92672">.</span>append(writer)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_on_connect(writer)
</span></span><span style="display:flex;"><span>    asyncio<span style="color:#f92672">.</span>create_task(self<span style="color:#f92672">.</span>_echo(reader, writer))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_on_connect</span>(self, writer: StreamWriter):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;sends a message to the client informing them how many other
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    users are connected and notify any other connected clients that
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    the new user has connected
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    writer<span style="color:#f92672">.</span>write(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Welcome! </span><span style="color:#e6db74">{</span>len(self<span style="color:#f92672">.</span>_writers)<span style="color:#e6db74">}</span><span style="color:#e6db74"> user(s) are online!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> writer<span style="color:#f92672">.</span>drain()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_notify_all(<span style="color:#e6db74">&#39;New user connected!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_echo</span>(self, reader: StreamReader, writer: StreamWriter):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;When a user disconnects, we notify any other connected clients
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    that someone disconnected
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">while</span> (data <span style="color:#f92672">:=</span> <span style="color:#66d9ef">await</span> reader<span style="color:#f92672">.</span>readline()) <span style="color:#f92672">!=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>:
</span></span><span style="display:flex;"><span>        writer<span style="color:#f92672">.</span>write(data)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> writer<span style="color:#f92672">.</span>drain()
</span></span><span style="display:flex;"><span>      self<span style="color:#f92672">.</span>_writers<span style="color:#f92672">.</span>remove(writer)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_notify_all((<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Client disconnected. </span><span style="color:#e6db74">{</span>len(self<span style="color:#f92672">.</span>_writers)<span style="color:#e6db74">}</span><span style="color:#e6db74"> user(s) are online!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>      logging<span style="color:#f92672">.</span>exception(<span style="color:#e6db74">&#39;Error reading from client.&#39;</span>, exc_info<span style="color:#f92672">=</span>e)
</span></span><span style="display:flex;"><span>      self<span style="color:#f92672">.</span>_writers<span style="color:#f92672">.</span>remove(writer)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_notify_all</span>(self, message: str):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> writer <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_writers:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        writer<span style="color:#f92672">.</span>write(message<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> writer<span style="color:#f92672">.</span>drain()
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ConnectionError</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logging<span style="color:#f92672">.</span>exception(<span style="color:#e6db74">&#39;Could not write to client.&#39;</span>, exc_info<span style="color:#f92672">=</span>e)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_writers<span style="color:#f92672">.</span>remove(writer)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  server_state <span style="color:#f92672">=</span> ServerState()
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">client_connected</span>(reader: StreamReader, writer: StreamWriter) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> server_state<span style="color:#f92672">.</span>add_client(reader, writer)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># start server and start serving forever</span>
</span></span><span style="display:flex;"><span>  server <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>start_server(client_connected, <span style="color:#e6db74">&#39;127.0.0.1&#39;</span>, <span style="color:#ae81ff">8000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> server:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> server<span style="color:#f92672">.</span>serve_forever()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><hr>
<h2 id="stream-reader">Stream reader</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncio <span style="color:#f92672">import</span> StreamReader
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> AsyncGenerator
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_until_empty</span>(stream_reader: StreamReader) <span style="color:#f92672">-&gt;</span> AsyncGenerator[str, <span style="color:#66d9ef">None</span>]:
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">while</span> response <span style="color:#f92672">:=</span> <span style="color:#66d9ef">await</span> stream_reader<span style="color:#f92672">.</span>readline():
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">yield</span> response<span style="color:#f92672">.</span>decode()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span> host: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;www.example.com&#39;</span>
</span></span><span style="display:flex;"><span> request: str <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;GET / HTTP/1.1</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span> \
</span></span><span style="display:flex;"><span>       <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Connection: close</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span> \
</span></span><span style="display:flex;"><span>       <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Host: </span><span style="color:#e6db74">{</span>host<span style="color:#e6db74">}</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> stream_reader, stream_writer <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>open_connection(host, <span style="color:#ae81ff">80</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>  stream_writer<span style="color:#f92672">.</span>write(request<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> stream_writer<span style="color:#f92672">.</span>drain()
</span></span><span style="display:flex;"><span>  responses <span style="color:#f92672">=</span> [ response <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">for</span> response <span style="color:#f92672">in</span> read_until_empty(stream_reader) ]
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(responses))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">finally</span>:
</span></span><span style="display:flex;"><span>  stream_writer<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> stream_writer<span style="color:#f92672">.</span>wait_closed()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><hr>
<h2 id="streams">Streams</h2>
<ul>
<li>Streams are a high-level set of classes and functions that create and manage network connections and generic streams of data.</li>
</ul>
<h3 id="stream-readers-and-stream-writers">Stream readers and stream writers</h3>
<ul>
<li>We develop networking applications in <code>asycnio</code> using <code>stream</code>. <a href="stream_reader.py" >code</a>
</li>
<li><code>open_connection</code> will create
<ul>
<li><code>StreamWriter</code> to send out the HTTP request
<ul>
<li><code>StreamWriter</code>&rsquo;s <code>write</code> method is a plain method.</li>
</ul>
</li>
<li><code>StreamReader</code> to read the response.</li>
</ul>
</li>
<li><code>drain</code> coroutine blocks until all queued data gets sent to the socket, ensuring we&rsquo;ve written everything before moving on.
<ul>
<li><code>write</code> -&gt; <code>await</code> -&gt; <code>drain</code></li>
</ul>
</li>
</ul>
<h3 id="using-streams-for-network-connections">Using streams for network connections</h3>
<ul>
<li><code>connect_read_pipe(&lt;protocol_factory&gt;, &lt;pipe&gt;)</code> connects a protocol to a file-like object.
<ul>
<li>A <em>protocol factory</em> is a function that creates a protocol instance.</li>
<li>A <em>pipe</em> is a file-like object, which is defined as an object with methods such as <code>read</code> and <code>write</code> on it.</li>
</ul>
</li>
<li><code>StreamReaderProtocol</code> connects instances of stream readers to protocols.
<ul>
<li>Using this, a command-line application will not be blocked by the event loop when waiting for the user input.</li>
</ul>
</li>
</ul>
<h3 id="processing-command-line-input-asynchronously">Processing command-line input asynchronously</h3>
<ul>
<li><a href="cli_sql.py" >code</a>
</li>
</ul>
<h3 id="creating-servers">Creating servers</h3>
<ul>
<li>
<p><a href="server.py" >code</a>
</p>
</li>
<li>
<p><code>asyncio.start_server(&lt;host&gt;, &lt;port&gt;, &lt;client_connected_cb&gt;)</code> creates servers without managing sockets.</p>
<ul>
<li><code>&lt;host&gt;</code> and <code>&lt;port&gt;</code> are the addresses that the server socket will listen for connections.</li>
<li><code>&lt;client_connected_cb&gt;</code> is either a callback function or a coroutine that will run whenever a client connects to the server.
<ul>
<li>This callback takes in a <code>StreamReader</code> and <code>StreamWriter</code> as parameters that will let us read from and write to the client that is connected to the server.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>When we await <code>start_server</code>, it will return an <code>AbstractServer</code> object.</p>
</li>
</ul>
<hr>
<h2 id="subroutine">Subroutine</h2>
<ul>
<li>A bit of code that can be called by another code.</li>
</ul>
<hr>
<h2 id="mapreduce-process-pools">Mapreduce process pools</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> concurrent.futures
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> functools
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Dict, List
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">partition</span>(data: List, chunk_size: int) <span style="color:#f92672">-&gt;</span> List:
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(data), chunk_size):
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">yield</span> data[i:i<span style="color:#f92672">+</span>chunk_size]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">map_frequencies</span>(chunk: List[str]) <span style="color:#f92672">-&gt;</span> Dict[str, int]:
</span></span><span style="display:flex;"><span> counter <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> chunk:
</span></span><span style="display:flex;"><span>  word, _, count, _ <span style="color:#f92672">=</span> line<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> counter<span style="color:#f92672">.</span>get(word):
</span></span><span style="display:flex;"><span>   counter[word] <span style="color:#f92672">+=</span> int(count)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>   counter[word] <span style="color:#f92672">=</span> int(count)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> counter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">merge_dictionaries</span>(first: Dict[str, int], second: Dict[str, int]) <span style="color:#f92672">-&gt;</span> Dict[str, int]:
</span></span><span style="display:flex;"><span> merged <span style="color:#f92672">=</span> first
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> second:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> key <span style="color:#f92672">in</span> merged:
</span></span><span style="display:flex;"><span>   merged[key] <span style="color:#f92672">+=</span> second[key]
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>   merged[key] <span style="color:#f92672">=</span> second[key]
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> merged
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">reduce</span>(loop, pool, counters, chunk_size) <span style="color:#f92672">-&gt;</span> Dict[str, int]:
</span></span><span style="display:flex;"><span> chunks: List[List[Dict]] <span style="color:#f92672">=</span> list(partition(counters, chunk_size))
</span></span><span style="display:flex;"><span> reducers <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">while</span> len(chunks[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> chunk <span style="color:#f92672">in</span> chunks:
</span></span><span style="display:flex;"><span>   reducer <span style="color:#f92672">=</span> functools<span style="color:#f92672">.</span>partial(functools<span style="color:#f92672">.</span>reduce, merge_dictionaries, chunk)
</span></span><span style="display:flex;"><span>   reducers<span style="color:#f92672">.</span>append(loop<span style="color:#f92672">.</span>run_in_executor(pool, reducer))
</span></span><span style="display:flex;"><span>  reducer_chunks <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>gather(<span style="color:#f92672">*</span>reducers)
</span></span><span style="display:flex;"><span>  chunks <span style="color:#f92672">=</span> list(partition(reducer_chunks, chunk_size))
</span></span><span style="display:flex;"><span>  reducers<span style="color:#f92672">.</span>clear()
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> chunks[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>(partition_size: int):
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;googlebooks-fre-all-1gram-20120701-a&#39;</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utf-8&#39;</span>) <span style="color:#66d9ef">as</span> file:
</span></span><span style="display:flex;"><span>  contents <span style="color:#f92672">=</span> file<span style="color:#f92672">.</span>readlines()
</span></span><span style="display:flex;"><span>  loop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_running_loop()
</span></span><span style="display:flex;"><span>  tasks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">with</span> concurrent<span style="color:#f92672">.</span>futures<span style="color:#f92672">.</span>ProcessPoolExecutor() <span style="color:#66d9ef">as</span> pool:
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">for</span> chunk <span style="color:#f92672">in</span> partition(contents, partition_size):
</span></span><span style="display:flex;"><span>    tasks<span style="color:#f92672">.</span>append(loop<span style="color:#f92672">.</span>run_in_executor(pool, functools<span style="color:#f92672">.</span>partial(map_frequencies, chunk)))
</span></span><span style="display:flex;"><span>   intermediate_results <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>gather(<span style="color:#f92672">*</span>tasks)
</span></span><span style="display:flex;"><span>   final_result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> reduce(loop, pool, intermediate_results, <span style="color:#ae81ff">500</span>)
</span></span><span style="display:flex;"><span>   print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Aardvark has appeared </span><span style="color:#e6db74">{</span>final_result[<span style="color:#e6db74">&#39;Aardvark&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74"> times.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span> asyncio<span style="color:#f92672">.</span>run(main(partition_size<span style="color:#f92672">=</span><span style="color:#ae81ff">60000</span>))
</span></span></code></pre></div><hr>
<h2 id="lock">Lock</h2>
<h3 id="process-lock">Process lock</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ProcessPoolExecutor
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> multiprocessing <span style="color:#f92672">import</span> Value
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>shared_counter: Value
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init</span>(counter: Value):
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">global</span> shared_counter
</span></span><span style="display:flex;"><span>  shared_counter <span style="color:#f92672">=</span> counter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">increment</span>():
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">with</span> shared_counter<span style="color:#f92672">.</span>get_lock():
</span></span><span style="display:flex;"><span>    shared_counter<span style="color:#f92672">.</span>value <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  counter <span style="color:#f92672">=</span> Value(<span style="color:#e6db74">&#39;d&#39;</span>, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">with</span> ProcessPoolExecutor(initializer<span style="color:#f92672">=</span>init, initargs<span style="color:#f92672">=</span>(counter,)) <span style="color:#66d9ef">as</span> pool:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>get_running_loop()<span style="color:#f92672">.</span>run_in_executor(pool, increment)
</span></span><span style="display:flex;"><span>    print(counter<span style="color:#f92672">.</span>value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>  asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><h3 id="thread-lock">Thread lock</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ThreadPoolExecutor
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> partial
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> threading <span style="color:#f92672">import</span> Lock
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>counter_lock <span style="color:#f92672">=</span> Lock()
</span></span><span style="display:flex;"><span>counter: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_status_code</span>(url: str) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">global</span> counter
</span></span><span style="display:flex;"><span>  response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">with</span> counter_lock:
</span></span><span style="display:flex;"><span>    counter <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> response<span style="color:#f92672">.</span>status_code
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">reporter</span>(request_count: int):
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> counter <span style="color:#f92672">&lt;</span> request_count:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Finished </span><span style="color:#e6db74">{</span>counter<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>request_count<span style="color:#e6db74">}</span><span style="color:#e6db74"> requests&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">.5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  loop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_running_loop()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">with</span> ThreadPoolExecutor() <span style="color:#66d9ef">as</span> pool:
</span></span><span style="display:flex;"><span>    request_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>    urls <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;https://www.example.com&#39;</span> <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(request_count)]
</span></span><span style="display:flex;"><span>    reporter_task <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(reporter(request_count))
</span></span><span style="display:flex;"><span>    tasks <span style="color:#f92672">=</span> [loop<span style="color:#f92672">.</span>run_in_executor(pool, partial(get_status_code, url)) <span style="color:#66d9ef">for</span> url <span style="color:#f92672">in</span> urls]
</span></span><span style="display:flex;"><span>    results <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>gather(<span style="color:#f92672">*</span>tasks)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> reporter_task
</span></span><span style="display:flex;"><span>    print(results)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><hr>
<h2 id="thread">Thread</h2>
<ul>
<li>A thread is alive if its <code>run</code> method is executing.</li>
<li>OS knows about each thread, and it can interrupt a thread at any time to start running a different thread.</li>
<li>It is created at the OS level and more expensive to create than coroutines.</li>
<li>It has a context-switching cost at the OS level. Saving and restoring thread state when a context switch happens eats up some of the performance gains obtained by using threads.</li>
<li>Each thread has an <code>Event Loop</code> object.</li>
</ul>
<h3 id="to-thread">to thread</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_status_code</span>(url: str) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span> response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> response<span style="color:#f92672">.</span>status_code
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span> urls <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;https://www.example.com&#39;</span> <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1000</span>)]
</span></span><span style="display:flex;"><span> tasks <span style="color:#f92672">=</span> [asyncio<span style="color:#f92672">.</span>to_thread(get_status_code, url) <span style="color:#66d9ef">for</span> url <span style="color:#f92672">in</span> urls]
</span></span><span style="display:flex;"><span> results <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>gather(<span style="color:#f92672">*</span>tasks)
</span></span><span style="display:flex;"><span> print(results)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><hr>
<h2 id="synchronization">Synchronization</h2>
<h3 id="asyncio-lock">asyncio lock</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncio <span style="color:#f92672">import</span> Lock
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util.delay <span style="color:#f92672">import</span> delay
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">a</span>(lock: Lock):
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#39;Coroutine a waiting to acquire the lock&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> lock:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;Coroutine a is in the critical section&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> delay(<span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#39;Coroutine a released the lock&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">b</span>(lock: Lock):
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#39;Coroutine b waiting to acquire the lock&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> lock:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;Coroutine b is in the critical section&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> delay(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#39;Coroutine b released the lock&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>  sys<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;../util&#39;</span>)
</span></span><span style="display:flex;"><span>  lock <span style="color:#f92672">=</span> Lock()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>gather(a(lock), b(lock))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(main())
</span></span></code></pre></div><ul>
<li>When we write applications using multiple threads and multiple processes, we need to worry about race conditions when using non-atomic operations.</li>
<li>Most objects in <code>asyncio</code> provide an optional loop parameter that lets you specify the specific <code>event loop</code> to run in. When this parameter is not provided, <code>asyncio</code> tries to get the currently running <code>event loop</code>, but if there is none, it creates a new one. (Parameters will be removed with version 3.10.)</li>
</ul>
<h3 id="single-threaded-concurrency-issues">Single-threaded concurrency issues</h3>
<ul>
<li>
<p>In asyncio&rsquo;s single-threaded model, we only have one thread executing one line of Python code at any given time. This means that even if an operation is non-atomic, we&rsquo;ll always run it to completion without other coroutines reading inconsistent state information.</p>
</li>
<li>
<p>Single-threaded concurrency bugs differ from concurrency bugs in multithreading and multiprocessing.</p>
</li>
</ul>
<h3 id="uses-of-synchronization-primitives">Uses of synchronization primitives</h3>
<ul>
<li>Preventing concurrency bugs</li>
<li>While working with an API
<ul>
<li>that makes only a few requests concurrently as per a contract we have with a vendor.</li>
<li>where we&rsquo;re concerned about overloading.</li>
</ul>
</li>
<li>A workflow with several workers that need to be notified when new data is available.</li>
</ul>
<h3 id="solving-race-conditions-_with_-locks-and-other-concurrency-primitives">Solving race conditions <em>with</em> locks and other concurrency primitives</h3>
<h4 id="using-locks-to-protect-critical-sections">Using locks to protect critical sections</h4>
<ul>
<li><code>Lock</code> is an <code>asyncio</code> synchronization primitive</li>
<li>Locks to prevent concurrency bugs and synchronize <code>coroutine</code>s
<ul>
<li>They can sometimes be needed when the shared state could change during <code>await</code>.</li>
</ul>
</li>
<li><code>asyncio</code> locks are awaitable objects that suspend <code>coroutine</code> execution when they are blocked.</li>
<li><code>async with</code> is recommended use because <code>asyncio</code> locks are context managers. <a href="asyncio_lock.py" >code</a>
</li>
</ul>
<h3 id="limiting-concurrency-and-controlling-access-to-a-shared-source-_with_-semaphores">Limiting concurrency and controlling access to a shared source <em>with</em> semaphores</h3>
<ul>
<li>How to use semaphores to control access to finite resources and limit concurrency, which can be useful in traffic-shaping</li>
</ul>
<h3 id="notifying-tasks-when-something-occurs-and-acquiring-the-shared-sources-when-it-happens-_with_-events-and-conditions">Notifying tasks when something occurs and acquiring the shared sources when it happens <em>with</em> events and conditions</h3>
<ul>
<li>How to use events to trigger actions when something happens, such as initialization or waking up worker tasks</li>
<li>How to use conditions to wait for an action and, because of an action, gain access to a shared resource</li>
</ul>
<h3 id="queues">Queues</h3>
<hr>
<h2 id="utils">utils</h2>
<h3 id="async-timed">async timed</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> functools
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Callable, Any
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">async_timed</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(func: Callable) <span style="color:#f92672">-&gt;</span> Callable:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@functools.wraps</span>(func)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapped</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs) <span style="color:#f92672">-&gt;</span> Any:
</span></span><span style="display:flex;"><span>      print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;starting </span><span style="color:#e6db74">{</span>func<span style="color:#e6db74">}</span><span style="color:#e6db74"> with args </span><span style="color:#e6db74">{</span>args<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>kwargs<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>      start <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> func(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">finally</span>:
</span></span><span style="display:flex;"><span>        end <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        total <span style="color:#f92672">=</span> end <span style="color:#f92672">-</span> start
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;finished </span><span style="color:#e6db74">{</span>func<span style="color:#e6db74">}</span><span style="color:#e6db74"> in </span><span style="color:#e6db74">{</span>total<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> second(s)&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> wrapped
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> wrapper
</span></span></code></pre></div><h3 id="create-stdin-reader">create stdin reader</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncio <span style="color:#f92672">import</span> StreamReader
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_stdin_reader</span>() <span style="color:#f92672">-&gt;</span> StreamReader:
</span></span><span style="display:flex;"><span>  stream_reader <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>StreamReader()
</span></span><span style="display:flex;"><span>  protocol <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>StreamReaderProtocol(stream_reader)
</span></span><span style="display:flex;"><span>  loop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_running_loop()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">await</span> loop<span style="color:#f92672">.</span>connect_read_pipe(<span style="color:#66d9ef">lambda</span>: protocol, sys<span style="color:#f92672">.</span>stdin)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> stream_reader
</span></span></code></pre></div><h3 id="cursor">cursor</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> shutil
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> asyncio <span style="color:#f92672">import</span> StreamReader
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> deque
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">save_cursor_position</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">7&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">restore_cursor_position</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">8&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">move_to_bottom_of_screen</span>() <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span> _, total_rows <span style="color:#f92672">=</span> shutil<span style="color:#f92672">.</span>get_terminal_size()
</span></span><span style="display:flex;"><span> input_row <span style="color:#f92672">=</span> total_rows <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[</span><span style="color:#e6db74">{</span>input_row<span style="color:#e6db74">}</span><span style="color:#e6db74">E&#39;</span>)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> total_rows
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">move_to_top_of_screen</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[H&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">move_back_one_char</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[1D&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete_line</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[2K&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">clear_line</span>():
</span></span><span style="display:flex;"><span> sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[2K</span><span style="color:#ae81ff">\033</span><span style="color:#e6db74">[0G&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_line</span>(stdin_reader: StreamReader) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">erase_last_char</span>():
</span></span><span style="display:flex;"><span>  move_back_one_char()
</span></span><span style="display:flex;"><span>  sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39; &#39;</span>)
</span></span><span style="display:flex;"><span>  move_back_one_char()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> delete_char <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x7f</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span> input_buffer <span style="color:#f92672">=</span> deque()
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">while</span> ( input_char <span style="color:#f92672">:=</span> <span style="color:#66d9ef">await</span> stdin_reader<span style="color:#f92672">.</span>read(<span style="color:#ae81ff">1</span>)) <span style="color:#f92672">!=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> input_char <span style="color:#f92672">==</span> delete_char:
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> len(input_buffer) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>    input_buffer<span style="color:#f92672">.</span>pop()
</span></span><span style="display:flex;"><span>    erase_last_char()
</span></span><span style="display:flex;"><span>    sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>   input_buffer<span style="color:#f92672">.</span>append(input_char)
</span></span><span style="display:flex;"><span>   sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>write(input_char<span style="color:#f92672">.</span>decode())
</span></span><span style="display:flex;"><span>   sys<span style="color:#f92672">.</span>stdout<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span> clear_line()
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(input_buffer)<span style="color:#f92672">.</span>decode()
</span></span></code></pre></div><h3 id="delay">delay</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">It will help us see what other code, if any,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">is running concurrently while our coroutines
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">are paused.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delay</span>(delay_seconds: int) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span> print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;sleeping for </span><span style="color:#e6db74">{</span>delay_seconds<span style="color:#e6db74">}</span><span style="color:#e6db74"> second(s)&#39;</span>)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(delay_seconds)
</span></span><span style="display:flex;"><span> print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;finished sleeping for </span><span style="color:#e6db74">{</span>delay_seconds<span style="color:#e6db74">}</span><span style="color:#e6db74"> second(s)&#39;</span>)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> delay_seconds
</span></span></code></pre></div><h3 id="fetch-status">fetch status</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> aiohttp <span style="color:#f92672">import</span> ClientSession, ClientTimeout
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fetch_status</span>(session: ClientSession, url: str) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ten_millis <span style="color:#f92672">=</span> ClientTimeout(total<span style="color:#f92672">=</span><span style="color:#ae81ff">.01</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> session<span style="color:#f92672">.</span>get(url, timeout<span style="color:#f92672">=</span>ten_millis) <span style="color:#66d9ef">as</span> result: <span style="color:#75715e"># we can process the result within this block</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result<span style="color:#f92672">.</span>status
</span></span></code></pre></div><h3 id="message-store">message store</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> deque
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Awaitable, Callable, Deque
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MessageStore</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> __init__(self, callback: Callable[[Deque], Awaitable[<span style="color:#66d9ef">None</span>]], max_size: int):
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>_deque <span style="color:#f92672">=</span> deque(maxlen<span style="color:#f92672">=</span>max_size)
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>_callback <span style="color:#f92672">=</span> callback
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">append</span>(self, item):
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>_deque<span style="color:#f92672">.</span>append(item)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_callback(self<span style="color:#f92672">.</span>_deque)
</span></span></code></pre></div>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/python/" rel="tag">Python</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/coding/" rel="tag">coding</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/algorithms/" rel="tag">algorithms</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/data-structures/" rel="tag">data structures</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<div class="authorbox__header">
		<span class="authorbox__name">About Fatma Kahveci</span>
	</div>
</div>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/python-note/conda/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Conda</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/python-note/comprehensions/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Comprehensions</p>
		</a>
	</div>
</nav>

<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "www-fatmakahveci-com-1" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			<aside class="sidebar">
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/coding-note/apache_hbase/">Apache HBase</a></li>
			<li class="widget__item"><a class="widget__link" href="/coding-note/binary_tree_traversal/">Binary tree traversal</a></li>
			<li class="widget__item"><a class="widget__link" href="/coding-note/concurrency/">Concurrency</a></li>
			<li class="widget__item"><a class="widget__link" href="/coding-note/cdn/">Content delivery network (CDN)</a></li>
			<li class="widget__item"><a class="widget__link" href="/coding-note/database/">Database</a></li>
			<li class="widget__item"><a class="widget__link" href="/coding-note/dog_pile_effect/">Dogpile effect</a></li>
			<li class="widget__item"><a class="widget__link" href="/coding-note/dynamic_programming/">Dynamic Programming (DP)</a></li>
			<li class="widget__item"><a class="widget__link" href="/coding-note/google_bigtable/">Google BigTable</a></li>
			<li class="widget__item"><a class="widget__link" href="/coding-note/jaccard_similarity/">Jaccard Similarity</a></li>
			<li class="widget__item"><a class="widget__link" href="/coding-note/mongodb/">MongoDB</a></li>
		</ul>
	</div>
</div>
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Spotify" rel="noopener noreferrer" href="https://open.spotify.com/playlist/2lY1JpIvZI8T1SG8RAaosw?si=CvDn8z0xQlaA9RtXUGM_2g" target="_blank">
				
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="24px" height="24px"
	 viewBox="0 0 496 496" style="enable-background:new 0 0 496 496;" xml:space="preserve">
<path id="SVGCleanerId_0" style="fill:#37D660;" d="M248,0C111.608,0,0,111.6,0,248c0,136.392,111.608,248,248,248
	c136.4,0,248-111.608,248-248C496,111.6,385.648,0,248,0z M362.072,358.352c-4.936,7.448-13.624,9.928-21.072,4.96
	c-58.28-35.96-131.448-43.392-218.224-23.544c-8.704,2.464-16.128-3.736-18.608-11.168c-2.488-8.68,3.72-16.128,11.16-18.6
	c94.232-21.08,176.08-12.4,240.56,27.28C364.552,341,365.808,350.92,362.072,358.352z M391.84,290.16
	c-6.192,8.68-17.368,12.392-26.04,6.192c-66.96-40.912-168.64-53.32-246.768-28.512c-9.904,2.48-21.08-2.488-23.56-12.4
	c-2.48-9.92,2.488-21.088,12.408-23.568c90.52-27.272,202.12-13.648,279,33.48C394.32,269.072,398.04,281.48,391.84,290.16z
	 M426.552,214.512c-6.184,8.672-21.08,12.408-32.232,6.184c-79.36-47.104-212.032-52.064-287.672-28.512
	c-12.416,3.736-24.808-3.712-28.512-14.872C74.4,164.92,81.848,152.512,93,148.8c88.04-26.032,233.136-21.096,324.88,33.488
	C429.04,188.48,432.776,203.352,426.552,214.512z"/>
<g>
	<path id="SVGCleanerId_0_1_" style="fill:#37D660;" d="M248,0C111.608,0,0,111.6,0,248c0,136.392,111.608,248,248,248
		c136.4,0,248-111.608,248-248C496,111.6,385.648,0,248,0z M362.072,358.352c-4.936,7.448-13.624,9.928-21.072,4.96
		c-58.28-35.96-131.448-43.392-218.224-23.544c-8.704,2.464-16.128-3.736-18.608-11.168c-2.488-8.68,3.72-16.128,11.16-18.6
		c94.232-21.08,176.08-12.4,240.56,27.28C364.552,341,365.808,350.92,362.072,358.352z M391.84,290.16
		c-6.192,8.68-17.368,12.392-26.04,6.192c-66.96-40.912-168.64-53.32-246.768-28.512c-9.904,2.48-21.08-2.488-23.56-12.4
		c-2.48-9.92,2.488-21.088,12.408-23.568c90.52-27.272,202.12-13.648,279,33.48C394.32,269.072,398.04,281.48,391.84,290.16z
		 M426.552,214.512c-6.184,8.672-21.08,12.408-32.232,6.184c-79.36-47.104-212.032-52.064-287.672-28.512
		c-12.416,3.736-24.808-3.712-28.512-14.872C74.4,164.92,81.848,152.512,93,148.8c88.04-26.032,233.136-21.096,324.88,33.488
		C429.04,188.48,432.776,203.352,426.552,214.512z"/>
</g>
<path style="fill:#2CC64D;" d="M219.68,195.296c-94.952,0-177.16,35.576-217.168,87.448C19.536,402.832,123.384,496,248,496
	c90.016,0,169.208-48.624,212.664-120.872c1.392-6.856,2.168-13.84,2.168-20.952C462.832,266.424,353.976,195.296,219.68,195.296z
	 M362.072,358.352c-4.936,7.448-13.624,9.928-21.072,4.96c-58.28-35.96-131.448-43.392-218.224-23.544
	c-8.704,2.464-16.128-3.736-18.608-11.168c-2.488-8.68,3.72-16.128,11.16-18.6c94.232-21.08,176.08-12.4,240.56,27.28
	C364.552,341,365.808,350.92,362.072,358.352z M391.84,290.16c-6.192,8.68-17.368,12.392-26.04,6.192
	c-66.96-40.912-168.64-53.32-246.768-28.512c-9.904,2.48-21.08-2.488-23.56-12.4c-2.48-9.92,2.488-21.088,12.408-23.568
	c90.52-27.272,202.12-13.648,279,33.48C394.32,269.072,398.04,281.48,391.84,290.16z"/>
<path style="fill:#5AF27A;" d="M248,36.816c131.384,0,237.808,101.68,247.248,229.536C495.696,260.288,496,254.168,496,248
	C496,111.6,385.648,0,248,0C111.608,0,0,111.6,0,248c0,6.184,0.304,12.328,0.76,18.408C10.272,138.512,117.808,36.816,248,36.816z"
	/>
<path style="fill:#1DAA59;" d="M326.192,483.216c14.488-33.36,32.688-83.248,35.872-88.056c3.736-7.432,2.488-17.352-6.184-21.072
	c-64.488-39.68-146.328-48.36-240.56-27.28c-7.44,2.48-13.64,9.92-11.16,18.6c1.248,3.76,6.512,49.088,12.528,92.632
	C154.832,482.048,199.848,496,248,496C275.304,496,301.568,491.464,326.192,483.216z"/>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
</svg>

				<span>Spotify</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Twitter" rel="noopener noreferrer" href="https://twitter.com/science_n_code" target="_blank">
				<svg class="widget-social__link-icon icon icon-twitter" width="24" height="24" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5 0-78.8 35.3-78.8 78.8 0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3-6.7 11.6-10.6 25.2-10.6 39.6 0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1 0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4 0-12.6-.4-18.8-1.1 34.9 22.4 76.3 35.4 120.8 35.4 144.9 0 224.1-120 224.1-224.1 0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg>
				<span>Twitter</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Instagram" rel="noopener noreferrer" href="https://www.instagram.com/fatmakhv" target="_blank">
				<svg class="widget-social__link-icon icon icon-instagram" width="24" height="24" viewBox="0 0 256 256"><circle cx="193" cy="59" r="15"/><path fill-rule="evenodd" d="M101 0h54c41 0 58.4 3.9 74.5 17C256.2 37.5 256 74.8 256 97.7v60c0 26.7 0 60.4-26.5 81.4-16 13.4-33.5 16.9-74.5 16.9h-54c-41 0-57.5-3.5-74.5-16.9C1 218.9.5 186.3.1 160.5L0 155V97.7c0-23-.2-60.2 26.5-80.7C45 2 60 0 101 0zm4.9 23h44.3c45.8 0 58.3 3.5 70.3 17.5 11.8 13.2 12 30.1 12.5 62.9V156c.2 20.8.3 45.8-12.5 59.5-12 14-24.5 17.5-70.3 17.5h-44.3c-45.9 0-57.3-3.5-70.4-17.5-12.2-13-12.3-36.5-12.4-56.7v-55.6c.4-32.6.7-49.6 12.4-62.7C48 26.5 60 23 105.9 23zm19.6 144.5a42 42 0 1 0 0-84 42 42 0 0 0 0 84zm0 22.5a64.5 64.5 0 1 0 0-129 64.5 64.5 0 0 0 0 129z"/></svg>
				<span>Instagram</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="LinkedIn" rel="noopener noreferrer" href="https://linkedin.com/in/fatma-kahveci" target="_blank">
				<svg class="widget-social__link-icon icon icon-linkedin" width="24" height="24" viewBox="0 0 352 352"><path d="M0,40v272c0,21.9,18.1,40,40,40h272c21.9,0,40-18.1,40-40V40c0-21.9-18.1-40-40-40H40C18.1,0,0,18.1,0,40z M312,32 c4.6,0,8,3.4,8,8v272c0,4.6-3.4,8-8,8H40c-4.6,0-8-3.4-8-8V40c0-4.6,3.4-8,8-8H312z M59.5,87c0,15.2,12.3,27.5,27.5,27.5 c15.2,0,27.5-12.3,27.5-27.5c0-15.2-12.3-27.5-27.5-27.5C71.8,59.5,59.5,71.8,59.5,87z M187,157h-1v-21h-45v152h47v-75 c0-19.8,3.9-39,28.5-39c24.2,0,24.5,22.4,24.5,40v74h47v-83.5c0-40.9-8.7-72-56.5-72C208.5,132.5,193.3,145.1,187,157z M64,288h47.5 V136H64V288z"/></svg>
				<span>LinkedIn</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/fatmakahveci" target="_blank">
				<svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>

		
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/algorithm/" title="algorithm">algorithm</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/algorithms/" title="algorithms">algorithms</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/aws/" title="aws">aws</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/bacteria/" title="bacteria">bacteria</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/bacterial-strain-identification/" title="bacterial strain identification">bacterial strain identification</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/bash/" title="bash">bash</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/bfs/" title="bfs">bfs</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/big-oh-notation/" title="big-oh-notation">big-oh-notation</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/bigtable/" title="bigtable">bigtable</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/bioinformatician/" title="bioinformatician">bioinformatician</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/bioinformatics/" title="bioinformatics">bioinformatics</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/bioinform%C3%A1tica/" title="bioinformática">bioinformática</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/biyoinformatik/" title="biyoinformatik">biyoinformatik</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/cloud-computing/" title="cloud computing">cloud computing</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/coding/" title="coding">coding</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/concurrency/" title="concurrency">concurrency</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/covid19/" title="covid19">covid19</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/css/" title="css">css</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/data/" title="data">data</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/data-structures/" title="data structures">data structures</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/database/" title="database">database</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/design-patterns/" title="design patterns">design patterns</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/dfs/" title="dfs">dfs</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/diccionario/" title="diccionario">diccionario</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/dictionary/" title="dictionary">dictionary</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/django/" title="Django">Django</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/en-es/" title="en-es">en-es</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/en-tr/" title="en-tr">en-tr</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/framework/" title="framework">framework</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/frontend/" title="frontend">frontend</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/gene-transfer/" title="gene transfer">gene transfer</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/go/" title="go">go</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/html/" title="html">html</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/javascript/" title="javascript">javascript</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/mongodb/" title="MongoDB">MongoDB</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/network/" title="network">network</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/newbies/" title="newbies">newbies</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/nextjs/" title="nextjs">nextjs</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/nosql/" title="nosql">nosql</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/numpy/" title="NumPy">NumPy</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/post/" title="post">post</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/python/" title="Python">Python</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/react/" title="react">react</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/reading/" title="reading">reading</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/redux/" title="redux">redux</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/software/" title="Software">Software</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/sql/" title="sql">sql</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/strain/" title="strain">strain</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/s%C3%B6zl%C3%BCk/" title="sözlük">sözlük</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/travel/" title="travel">travel</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/tree-traversal/" title="tree traversal">tree traversal</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/turkey/" title="turkey">turkey</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/typescript/" title="typescript">typescript</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/user-interface/" title="user interface">user interface</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/web-development/" title="web development">web development</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/webpack/" title="webpack">webpack</a>
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 Fatma Kahveci.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
<script src="/js/custom.js"></script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG" async></script>
</body>
</html>